[
{
  "model": "desktop.document2",
  "pk": 153918,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "ARGOS: Criar Tabelas",
    "description": "",
    "uuid": "3038469e-48d2-796e-a787-142ccea14afa",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 153918, \"uuid\": \"c1434f11-bbf9-459e-a12e-ce590d0079cb\", \"name\": \"ARGOS: Criar Tabelas\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"3038469e-48d2-796e-a787-142ccea14afa\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"9458dadb-c2bc-d8b5-c981-6d2cea3a8e04\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 27, \"column\": 0}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"niat\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 2, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- SISTEMA DE AN\\u00c1LISE DE COMPORTAMENTO TRIBUT\\u00c1RIO POR PRODUTO - V4.0 (VERS\\u00c3O FINAL)\\r\\n-- Fonte de Dados: nfce.nfce (dados originais aninhados)  \\r\\n-- Foco: Varia\\u00e7\\u00e3o da al\\u00edquota ponderada para empresas fiscalizadas (niat.argos_cnpj)\\r\\n-- ============================================================================\\r\\n-- MELHORIAS V4.0:\\r\\n-- - CORRIGIDO: Usa CROSS JOIN ao inv\\u00e9s da sintaxe de v\\u00edrgula (sintaxe validada)\\r\\n-- - Simplificado: Cria diretamente a tabela base sem tabela tempor\\u00e1ria\\r\\n-- - Otimizado: Baseado no c\\u00f3digo que funcionou fornecido pelo usu\\u00e1rio\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1. TABELA BASE: EXTRA\\u00c7\\u00c3O E FLATTENING COM SINTAXE VALIDADA\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_nfce_base_extraida;\\r\\nCREATE TABLE niat.argos_nfce_base_extraida STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Campos do cabe\\u00e7alho da nota\\r\\n    a.procnfe.nfe.infnfe.emit.cnpj AS cnpj_emitente,\\r\\n    -- Cria\\u00e7\\u00e3o do Per\\u00edodo\\r\\n    CONCAT(CAST(a.ano_emissao AS STRING), LPAD(CAST(a.mes_emissao AS STRING), 2, '0')) AS periodo,\\r\\n    -- Campos do Produto (extra\\u00eddos diretamente do item desaninhado 'd')\\r\\n    CASE\\r\\n        WHEN d.prod.cean IS NULL OR d.prod.cean = '' OR NOT d.prod.cean RLIKE '^[0-9]+$' THEN 'SEM GTIN'\\r\\n        ELSE REGEXP_REPLACE(d.prod.cean, '^0+', '')\\r\\n    END AS gtin,\\r\\n    d.prod.ncm AS ncm,\\r\\n    TRIM(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(d.prod.xprod), '\\\\\\\\s*[-./\\\\\\\\|!@&+(){}$%=,#?\\u00ba\\u00aa\\u00b0;<>:\\\"]+\\\\\\\\s*', ' '),  '\\\\\\\\s{2,}', ' ')) AS descricao,\\r\\n    -- Base de C\\u00e1lculo\\r\\n    (COALESCE(d.prod.vprod, 0) + COALESCE(d.prod.vfrete, 0) + COALESCE(d.prod.vseg, 0) + COALESCE(d.prod.voutro, 0) - COALESCE(d.prod.vdesc, 0)) AS bc_fisco,\\r\\n    -- Al\\u00edquota do Emitente (tentando diferentes estruturas de ICMS)\\r\\n    COALESCE(\\r\\n        d.imposto.icms.resumo.picms,\\r\\n        d.imposto.icms.icms00.picms,\\r\\n        d.imposto.icms.icms10.picms,\\r\\n        d.imposto.icms.icms20.picms,\\r\\n        d.imposto.icms.icms90.picms,\\r\\n        0\\r\\n    ) / 100.0 AS aliquota_emitente,\\r\\n    \\r\\n    -- Valor do ICMS (tentando diferentes estruturas de ICMS)\\r\\n    COALESCE(\\r\\n        d.imposto.icms.resumo.vicms,\\r\\n        d.imposto.icms.icms00.vicms,\\r\\n        d.imposto.icms.icms10.vicms,\\r\\n        d.imposto.icms.icms20.vicms,\\r\\n        d.imposto.icms.icms90.vicms,\\r\\n        0\\r\\n    ) AS icms_emitente\\r\\nFROM\\r\\n    -- Tabela principal com alias 'a'\\r\\n    nfce.nfce a\\r\\n    -- Desaninhamento (unnest) do array 'det' com alias 'd' usando CROSS JOIN\\r\\n    CROSS JOIN a.procnfe.nfe.infnfe.det d\\r\\n    -- Filtro inicial para performance, juntando com os CNPJs de interesse\\r\\n    INNER JOIN niat.argos_cnpj fiscalizadas ON a.procnfe.nfe.infnfe.emit.cnpj = fiscalizadas.cnpj\\r\\nWHERE\\r\\n    -- Filtros da regra de neg\\u00f3cio\\r\\n    a.ano_emissao IN (2023, 2024, 2025)\\r\\n    AND a.situacao = 1\\r\\n    AND a.procnfe.nfe.infnfe.ide.tpnf = 1 -- 1=Sa\\u00edda\\r\\n    AND a.procnfe.nfe.infnfe.ide.finnfe = 1 -- 1=NF-e Normal\\r\\n    AND a.procnfe.nfe.infnfe.emit.crt <> 1; -- Exclui Simples Nacional\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2. TABELA DE PER\\u00cdODO: AL\\u00cdQUOTA PONDERADA E ENRIQUECIMENTO COM IA\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_nfce_periodo_base;\\r\\nCREATE TABLE niat.argos_nfce_periodo_base STORED AS PARQUET AS\\r\\nWITH ponderacao AS (\\r\\n    SELECT\\r\\n        periodo,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        SUM(aliquota_emitente * bc_fisco) AS total_aliquota_ponderada,\\r\\n        SUM(bc_fisco) AS bc_total_periodo,\\r\\n        SUM(icms_emitente) as icms_total_emitente\\r\\n    FROM niat.argos_nfce_base_extraida\\r\\n    WHERE bc_fisco > 0\\r\\n    GROUP BY periodo, cnpj_emitente, gtin, ncm, descricao\\r\\n)\\r\\nSELECT\\r\\n    p.periodo,\\r\\n    p.cnpj_emitente,\\r\\n    p.gtin,\\r\\n    p.ncm,\\r\\n    p.descricao,\\r\\n    p.bc_total_periodo,\\r\\n    p.icms_total_emitente,\\r\\n    p.total_aliquota_ponderada / p.bc_total_periodo AS aliquota_emitente_media_ponderada,\\r\\n    COALESCE(ia_gtin.aliquota_ia, ia_ncm.aliquota_ia) AS aliquota_ia\\r\\nFROM ponderacao p\\r\\nLEFT JOIN niat.tabela_niat ia_gtin ON p.gtin = ia_gtin.gtin AND p.gtin <> 'SEM GTIN'\\r\\nLEFT JOIN niat.tabela_niat ia_ncm ON p.ncm = ia_ncm.ncm AND p.descricao = ia_ncm.descricao AND p.gtin = 'SEM GTIN';\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3. C\\u00c1LCULO DAS M\\u00c9DIAS HIST\\u00d3RICAS POR EMPRESA E PRODUTO\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_medias_historicas_produto;\\r\\nCREATE TABLE niat.argos_medias_historicas_produto STORED AS PARQUET AS\\r\\nSELECT\\r\\n  cnpj_emitente, gtin, ncm, descricao, aliquota_ia,\\r\\n  COUNT(DISTINCT periodo) AS qtd_periodos_produto,\\r\\n  AVG(aliquota_emitente_media_ponderada) AS aliq_emitente_media_historica,\\r\\n  STDDEV(aliquota_emitente_media_ponderada) AS aliq_emitente_desvio_historico\\r\\nFROM niat.argos_nfce_periodo_base\\r\\nGROUP BY cnpj_emitente, gtin, ncm, descricao, aliquota_ia\\r\\nHAVING COUNT(DISTINCT periodo) >= 3;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4. AN\\u00c1LISE DE MUDAN\\u00c7A DE COMPORTAMENTO POR PER\\u00cdODO\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_mudanca_comportamento;\\r\\nCREATE TABLE niat.argos_mudanca_comportamento STORED AS PARQUET AS\\r\\nSELECT\\r\\n  bp.periodo, bp.cnpj_emitente, c.nm_razao_social, bp.gtin, bp.ncm, bp.descricao,\\r\\n  bp.aliquota_ia,\\r\\n  bp.aliquota_emitente_media_ponderada AS aliq_emitente_periodo,\\r\\n  bp.bc_total_periodo,\\r\\n  mh.aliq_emitente_media_historica,\\r\\n  mh.aliq_emitente_desvio_historico,\\r\\n  \\r\\n  (bp.aliquota_emitente_media_ponderada - mh.aliq_emitente_media_historica) AS diferenca_vs_media_historica,\\r\\n  (bp.aliquota_emitente_media_ponderada - bp.aliquota_ia) AS diferenca_vs_ia_periodo,\\r\\n  (mh.aliq_emitente_media_historica - bp.aliquota_ia) AS diferenca_vs_ia_historica,\\r\\n  \\r\\n  CASE\\r\\n    WHEN mh.aliq_emitente_desvio_historico IS NULL OR mh.aliq_emitente_desvio_historico = 0 THEN 'PRODUTO_ESTAVEL'\\r\\n    WHEN ABS(bp.aliquota_emitente_media_ponderada - mh.aliq_emitente_media_historica) > (2 * mh.aliq_emitente_desvio_historico) THEN 'MUDANCA_EXTREMA'\\r\\n    WHEN ABS(bp.aliquota_emitente_media_ponderada - mh.aliq_emitente_media_historica) > mh.aliq_emitente_desvio_historico THEN 'MUDANCA_SIGNIFICATIVA'\\r\\n    ELSE 'COMPORTAMENTO_NORMAL'\\r\\n  END AS classificacao_mudanca,\\r\\n  \\r\\n  CASE\\r\\n    WHEN bp.aliquota_ia IS NULL THEN 'SEM_REFERENCIA_IA'\\r\\n    WHEN ABS(bp.aliquota_emitente_media_ponderada - bp.aliquota_ia) < ABS(mh.aliq_emitente_media_historica - bp.aliquota_ia) THEN 'APROXIMOU_DA_CORRETA'\\r\\n    WHEN ABS(bp.aliquota_emitente_media_ponderada - bp.aliquota_ia) > ABS(mh.aliq_emitente_media_historica - bp.aliquota_ia) THEN 'AFASTOU_DA_CORRETA'\\r\\n    ELSE 'MANTEVE_DISTANCIA'\\r\\n  END AS movimento_vs_ia\\r\\n\\r\\nFROM niat.argos_nfce_periodo_base bp\\r\\nINNER JOIN niat.argos_medias_historicas_produto mh \\r\\n    ON bp.cnpj_emitente = mh.cnpj_emitente \\r\\n    AND bp.gtin = mh.gtin \\r\\n    AND bp.ncm = mh.ncm \\r\\n    AND bp.descricao = mh.descricao\\r\\nLEFT JOIN usr_sat_ods.vw_ods_contrib c ON bp.cnpj_emitente = c.nu_cnpj;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 5. VIEW FINAL PARA AN\\u00c1LISE E CONSULTA\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.argos_vw_evolucao_nfce;\\r\\nCREATE VIEW niat.argos_vw_evolucao_nfce AS\\r\\nSELECT\\r\\n    periodo,\\r\\n    cnpj_emitente,\\r\\n    nm_razao_social,\\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    ROUND(aliq_emitente_periodo * 100, 2) AS aliquota_praticada_pct,\\r\\n    ROUND(aliq_emitente_media_historica * 100, 2) AS aliquota_historica_pct,\\r\\n    ROUND(aliquota_ia * 100, 2) AS aliquota_correta_ia_pct,\\r\\n    classificacao_mudanca,\\r\\n    movimento_vs_ia,\\r\\n    bc_total_periodo\\r\\nFROM niat.argos_mudanca_comportamento\\r\\nORDER BY cnpj_emitente, descricao, periodo;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6. CONSULTAS DE VERIFICA\\u00c7\\u00c3O E EXEMPLO DE USO\\r\\n-- ----------------------------------------------------------------------------\\r\\n\\r\\n-- Estat\\u00edsticas gerais do sistema\\r\\nSELECT \\r\\n    'Tabela Base' as tabela,\\r\\n    COUNT(*) as total_registros,\\r\\n    COUNT(DISTINCT cnpj_emitente) as empresas_distintas,\\r\\n    COUNT(DISTINCT periodo) as periodos_distintos,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) as produtos_distintos\\r\\nFROM niat.argos_nfce_base_extraida\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'View Final' as tabela,\\r\\n    COUNT(*) as total_registros,\\r\\n    COUNT(DISTINCT cnpj_emitente) as empresas_distintas,\\r\\n    COUNT(DISTINCT periodo) as periodos_distintos,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) as produtos_distintos\\r\\nFROM niat.argos_vw_evolucao_nfce;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- CONSULTAS ANAL\\u00cdTICAS DE EXEMPLO\\r\\n-- ----------------------------------------------------------------------------\\r\\n\\r\\n-- 1. Top 10 empresas com maior n\\u00famero de mudan\\u00e7as extremas em 2024\\r\\nSELECT \\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    COUNT(*) as total_mudancas_extremas,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) as produtos_afetados,\\r\\n    SUM(bc_total_periodo) as base_calculo_total\\r\\nFROM niat.argos_vw_evolucao_nfce\\r\\nWHERE classificacao_mudanca = 'MUDANCA_EXTREMA'\\r\\n  AND LEFT(periodo, 4) = '2024'\\r\\nGROUP BY nm_razao_social, cnpj_emitente\\r\\nORDER BY total_mudancas_extremas DESC\\r\\nLIMIT 10;\\r\\n\\r\\n-- 2. An\\u00e1lise de tend\\u00eancia por per\\u00edodo (\\u00faltimos 6 meses)\\r\\nSELECT \\r\\n    periodo,\\r\\n    COUNT(*) as total_casos,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) as mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) as mudancas_significativas,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) as afastou_da_correta,\\r\\n    SUM(bc_total_periodo) as base_calculo_total\\r\\nFROM niat.argos_vw_evolucao_nfce\\r\\nWHERE periodo >= '202409'  -- \\u00daltimos 6 meses a partir de 2024-09\\r\\nGROUP BY periodo\\r\\nORDER BY periodo DESC;\", \"statementsList\": [\"-- ============================================================================\\r\\n-- SISTEMA DE AN\\u00c1LISE DE COMPORTAMENTO TRIBUT\\u00c1RIO POR PRODUTO - V4.0 (VERS\\u00c3O FINAL)\\r\\n-- Fonte de Dados: nfce.nfce (dados originais aninhados)  \\r\\n-- Foco: Varia\\u00e7\\u00e3o da al\\u00edquota ponderada para empresas fiscalizadas (niat.argos_cnpj)\\r\\n-- ============================================================================\\r\\n-- MELHORIAS V4.0:\\r\\n-- - CORRIGIDO: Usa CROSS JOIN ao inv\\u00e9s da sintaxe de v\\u00edrgula (sintaxe validada)\\r\\n-- - Simplificado: Cria diretamente a tabela base sem tabela tempor\\u00e1ria\\r\\n-- - Otimizado: Baseado no c\\u00f3digo que funcionou fornecido pelo usu\\u00e1rio\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1. TABELA BASE: EXTRA\\u00c7\\u00c3O E FLATTENING COM SINTAXE VALIDADA\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_nfce_base_extraida;\", \"\\r\\nCREATE TABLE niat.argos_nfce_base_extraida STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Campos do cabe\\u00e7alho da nota\\r\\n    a.procnfe.nfe.infnfe.emit.cnpj AS cnpj_emitente,\\r\\n    -- Cria\\u00e7\\u00e3o do Per\\u00edodo\\r\\n    CONCAT(CAST(a.ano_emissao AS STRING), LPAD(CAST(a.mes_emissao AS STRING), 2, '0')) AS periodo,\\r\\n    -- Campos do Produto (extra\\u00eddos diretamente do item desaninhado 'd')\\r\\n    CASE\\r\\n        WHEN d.prod.cean IS NULL OR d.prod.cean = '' OR NOT d.prod.cean RLIKE '^[0-9]+$' THEN 'SEM GTIN'\\r\\n        ELSE REGEXP_REPLACE(d.prod.cean, '^0+', '')\\r\\n    END AS gtin,\\r\\n    d.prod.ncm AS ncm,\\r\\n    TRIM(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(d.prod.xprod), '\\\\\\\\s*[-./\\\\\\\\|!@&+(){}$%=,#?\\u00ba\\u00aa\\u00b0;<>:\\\"]+\\\\\\\\s*', ' '),  '\\\\\\\\s{2,}', ' ')) AS descricao,\\r\\n    -- Base de C\\u00e1lculo\\r\\n    (COALESCE(d.prod.vprod, 0) + COALESCE(d.prod.vfrete, 0) + COALESCE(d.prod.vseg, 0) + COALESCE(d.prod.voutro, 0) - COALESCE(d.prod.vdesc, 0)) AS bc_fisco,\\r\\n    -- Al\\u00edquota do Emitente (tentando diferentes estruturas de ICMS)\\r\\n    COALESCE(\\r\\n        d.imposto.icms.resumo.picms,\\r\\n        d.imposto.icms.icms00.picms,\\r\\n        d.imposto.icms.icms10.picms,\\r\\n        d.imposto.icms.icms20.picms,\\r\\n        d.imposto.icms.icms90.picms,\\r\\n        0\\r\\n    ) / 100.0 AS aliquota_emitente,\\r\\n    \\r\\n    -- Valor do ICMS (tentando diferentes estruturas de ICMS)\\r\\n    COALESCE(\\r\\n        d.imposto.icms.resumo.vicms,\\r\\n        d.imposto.icms.icms00.vicms,\\r\\n        d.imposto.icms.icms10.vicms,\\r\\n        d.imposto.icms.icms20.vicms,\\r\\n        d.imposto.icms.icms90.vicms,\\r\\n        0\\r\\n    ) AS icms_emitente\\r\\nFROM\\r\\n    -- Tabela principal com alias 'a'\\r\\n    nfce.nfce a\\r\\n    -- Desaninhamento (unnest) do array 'det' com alias 'd' usando CROSS JOIN\\r\\n    CROSS JOIN a.procnfe.nfe.infnfe.det d\\r\\n    -- Filtro inicial para performance, juntando com os CNPJs de interesse\\r\\n    INNER JOIN niat.argos_cnpj fiscalizadas ON a.procnfe.nfe.infnfe.emit.cnpj = fiscalizadas.cnpj\\r\\nWHERE\\r\\n    -- Filtros da regra de neg\\u00f3cio\\r\\n    a.ano_emissao IN (2023, 2024, 2025)\\r\\n    AND a.situacao = 1\\r\\n    AND a.procnfe.nfe.infnfe.ide.tpnf = 1 -- 1=Sa\\u00edda\\r\\n    AND a.procnfe.nfe.infnfe.ide.finnfe = 1 -- 1=NF-e Normal\\r\\n    AND a.procnfe.nfe.infnfe.emit.crt <> 1;\", \" -- Exclui Simples Nacional\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2. TABELA DE PER\\u00cdODO: AL\\u00cdQUOTA PONDERADA E ENRIQUECIMENTO COM IA\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_nfce_periodo_base;\", \"\\r\\nCREATE TABLE niat.argos_nfce_periodo_base STORED AS PARQUET AS\\r\\nWITH ponderacao AS (\\r\\n    SELECT\\r\\n        periodo,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        SUM(aliquota_emitente * bc_fisco) AS total_aliquota_ponderada,\\r\\n        SUM(bc_fisco) AS bc_total_periodo,\\r\\n        SUM(icms_emitente) as icms_total_emitente\\r\\n    FROM niat.argos_nfce_base_extraida\\r\\n    WHERE bc_fisco > 0\\r\\n    GROUP BY periodo, cnpj_emitente, gtin, ncm, descricao\\r\\n)\\r\\nSELECT\\r\\n    p.periodo,\\r\\n    p.cnpj_emitente,\\r\\n    p.gtin,\\r\\n    p.ncm,\\r\\n    p.descricao,\\r\\n    p.bc_total_periodo,\\r\\n    p.icms_total_emitente,\\r\\n    p.total_aliquota_ponderada / p.bc_total_periodo AS aliquota_emitente_media_ponderada,\\r\\n    COALESCE(ia_gtin.aliquota_ia, ia_ncm.aliquota_ia) AS aliquota_ia\\r\\nFROM ponderacao p\\r\\nLEFT JOIN niat.tabela_niat ia_gtin ON p.gtin = ia_gtin.gtin AND p.gtin <> 'SEM GTIN'\\r\\nLEFT JOIN niat.tabela_niat ia_ncm ON p.ncm = ia_ncm.ncm AND p.descricao = ia_ncm.descricao AND p.gtin = 'SEM GTIN';\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3. C\\u00c1LCULO DAS M\\u00c9DIAS HIST\\u00d3RICAS POR EMPRESA E PRODUTO\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_medias_historicas_produto;\", \"\\r\\nCREATE TABLE niat.argos_medias_historicas_produto STORED AS PARQUET AS\\r\\nSELECT\\r\\n  cnpj_emitente, gtin, ncm, descricao, aliquota_ia,\\r\\n  COUNT(DISTINCT periodo) AS qtd_periodos_produto,\\r\\n  AVG(aliquota_emitente_media_ponderada) AS aliq_emitente_media_historica,\\r\\n  STDDEV(aliquota_emitente_media_ponderada) AS aliq_emitente_desvio_historico\\r\\nFROM niat.argos_nfce_periodo_base\\r\\nGROUP BY cnpj_emitente, gtin, ncm, descricao, aliquota_ia\\r\\nHAVING COUNT(DISTINCT periodo) >= 3;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4. AN\\u00c1LISE DE MUDAN\\u00c7A DE COMPORTAMENTO POR PER\\u00cdODO\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_mudanca_comportamento;\", \"\\r\\nCREATE TABLE niat.argos_mudanca_comportamento STORED AS PARQUET AS\\r\\nSELECT\\r\\n  bp.periodo, bp.cnpj_emitente, c.nm_razao_social, bp.gtin, bp.ncm, bp.descricao,\\r\\n  bp.aliquota_ia,\\r\\n  bp.aliquota_emitente_media_ponderada AS aliq_emitente_periodo,\\r\\n  bp.bc_total_periodo,\\r\\n  mh.aliq_emitente_media_historica,\\r\\n  mh.aliq_emitente_desvio_historico,\\r\\n  \\r\\n  (bp.aliquota_emitente_media_ponderada - mh.aliq_emitente_media_historica) AS diferenca_vs_media_historica,\\r\\n  (bp.aliquota_emitente_media_ponderada - bp.aliquota_ia) AS diferenca_vs_ia_periodo,\\r\\n  (mh.aliq_emitente_media_historica - bp.aliquota_ia) AS diferenca_vs_ia_historica,\\r\\n  \\r\\n  CASE\\r\\n    WHEN mh.aliq_emitente_desvio_historico IS NULL OR mh.aliq_emitente_desvio_historico = 0 THEN 'PRODUTO_ESTAVEL'\\r\\n    WHEN ABS(bp.aliquota_emitente_media_ponderada - mh.aliq_emitente_media_historica) > (2 * mh.aliq_emitente_desvio_historico) THEN 'MUDANCA_EXTREMA'\\r\\n    WHEN ABS(bp.aliquota_emitente_media_ponderada - mh.aliq_emitente_media_historica) > mh.aliq_emitente_desvio_historico THEN 'MUDANCA_SIGNIFICATIVA'\\r\\n    ELSE 'COMPORTAMENTO_NORMAL'\\r\\n  END AS classificacao_mudanca,\\r\\n  \\r\\n  CASE\\r\\n    WHEN bp.aliquota_ia IS NULL THEN 'SEM_REFERENCIA_IA'\\r\\n    WHEN ABS(bp.aliquota_emitente_media_ponderada - bp.aliquota_ia) < ABS(mh.aliq_emitente_media_historica - bp.aliquota_ia) THEN 'APROXIMOU_DA_CORRETA'\\r\\n    WHEN ABS(bp.aliquota_emitente_media_ponderada - bp.aliquota_ia) > ABS(mh.aliq_emitente_media_historica - bp.aliquota_ia) THEN 'AFASTOU_DA_CORRETA'\\r\\n    ELSE 'MANTEVE_DISTANCIA'\\r\\n  END AS movimento_vs_ia\\r\\n\\r\\nFROM niat.argos_nfce_periodo_base bp\\r\\nINNER JOIN niat.argos_medias_historicas_produto mh \\r\\n    ON bp.cnpj_emitente = mh.cnpj_emitente \\r\\n    AND bp.gtin = mh.gtin \\r\\n    AND bp.ncm = mh.ncm \\r\\n    AND bp.descricao = mh.descricao\\r\\nLEFT JOIN usr_sat_ods.vw_ods_contrib c ON bp.cnpj_emitente = c.nu_cnpj;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 5. VIEW FINAL PARA AN\\u00c1LISE E CONSULTA\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.argos_vw_evolucao_nfce;\", \"\\r\\nCREATE VIEW niat.argos_vw_evolucao_nfce AS\\r\\nSELECT\\r\\n    periodo,\\r\\n    cnpj_emitente,\\r\\n    nm_razao_social,\\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    ROUND(aliq_emitente_periodo * 100, 2) AS aliquota_praticada_pct,\\r\\n    ROUND(aliq_emitente_media_historica * 100, 2) AS aliquota_historica_pct,\\r\\n    ROUND(aliquota_ia * 100, 2) AS aliquota_correta_ia_pct,\\r\\n    classificacao_mudanca,\\r\\n    movimento_vs_ia,\\r\\n    bc_total_periodo\\r\\nFROM niat.argos_mudanca_comportamento\\r\\nORDER BY cnpj_emitente, descricao, periodo;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6. CONSULTAS DE VERIFICA\\u00c7\\u00c3O E EXEMPLO DE USO\\r\\n-- ----------------------------------------------------------------------------\\r\\n\\r\\n-- Estat\\u00edsticas gerais do sistema\\r\\nSELECT \\r\\n    'Tabela Base' as tabela,\\r\\n    COUNT(*) as total_registros,\\r\\n    COUNT(DISTINCT cnpj_emitente) as empresas_distintas,\\r\\n    COUNT(DISTINCT periodo) as periodos_distintos,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) as produtos_distintos\\r\\nFROM niat.argos_nfce_base_extraida\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'View Final' as tabela,\\r\\n    COUNT(*) as total_registros,\\r\\n    COUNT(DISTINCT cnpj_emitente) as empresas_distintas,\\r\\n    COUNT(DISTINCT periodo) as periodos_distintos,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) as produtos_distintos\\r\\nFROM niat.argos_vw_evolucao_nfce;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"    TRIM(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(d.prod.xprod), '\\\\\\\\s*[-./\\\\\\\\|!@&+(){}$%=,#?\\u00ba\\u00aa\\u00b0;<>:\\\"]+\\\\\\\\s*', ' '),  '\\\\\\\\s{2,}', ' ')) AS descricao,\\r\\n    \", \"result\": {\"id\": \"ce0171dc-cfcd-2b5e-f109-4f35c48eded1\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"nUYokwNaQESB02KKVKHN2Q==\", \"guid\": \"2VxFT8iiTWYAAAAANc/3MQ==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"614aca3d2fe3c38d:222838473e0d2ebc\", \"session_id\": 21180, \"session_type\": \"impala\", \"statement_id\": 10, \"has_more_statements\": true, \"statements_count\": 13, \"previous_statement_hash\": \"eb3b06b4d09ce0109f06825722aa169228ce495409c76e4062720383\", \"start\": {\"row\": 171, \"column\": 0}, \"end\": {\"row\": 192, \"column\": 33}, \"statement\": \"-- ----------------------------------------------------------------------------\\n-- 6. CONSULTAS DE VERIFICA\\u00c7\\u00c3O E EXEMPLO DE USO\\n-- ----------------------------------------------------------------------------\\n\\n-- Estat\\u00edsticas gerais do sistema\\nSELECT \\n    'Tabela Base' as tabela,\\n    COUNT(*) as total_registros,\\n    COUNT(DISTINCT cnpj_emitente) as empresas_distintas,\\n    COUNT(DISTINCT periodo) as periodos_distintos,\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) as produtos_distintos\\nFROM niat.argos_nfce_base_extraida\\n\\nUNION ALL\\n\\nSELECT \\n    'View Final' as tabela,\\n    COUNT(*) as total_registros,\\n    COUNT(DISTINCT cnpj_emitente) as empresas_distintas,\\n    COUNT(DISTINCT periodo) as periodos_distintos,\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) as produtos_distintos\\nFROM niat.argos_vw_evolucao_nfce\"}, \"meta\": [], \"rows\": 2, \"hasMore\": false, \"statement_id\": 10, \"statement_range\": {\"start\": {\"row\": 171, \"column\": 0}, \"end\": {\"row\": 192, \"column\": 33}}, \"statements_count\": 13, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 5, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"tabela\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}, {\"name\": \"total_registros\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 2}, {\"name\": \"empresas_distintas\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 3}, {\"name\": \"periodos_distintos\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 4}, {\"name\": \"produtos_distintos\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 5}], \"fetchedOnce\": false, \"startTime\": \"2025-10-03T17:33:35.690Z\", \"endTime\": \"2025-10-03T17:33:44.608Z\", \"executionTime\": 8918, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 9, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 5367, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"tabela\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"empresas_distintas\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 5421, \"getLogsTimeout\": 5441, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1759512815395, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- ============================================================================\\r\\n-- SISTEMA DE AN\\u00c1LISE DE COMPORTAMENTO TRIBUT\\u00c1RIO POR PRODUTO - V4.0 (VERS\\u00c3O FINAL)\\r\\n-- Fonte de Dados: nfce.nfce (dados originais aninhados)  \\r\\n-- Foco: Varia\\u00e7\\u00e3o da al\\u00edquota ponderada para empresas fiscalizadas (niat.argos_cnpj)\\r\\n-- ============================================================================\\r\\n-- MELHORIAS V4.0:\\r\\n-- - CORRIGIDO: Usa CROSS JOIN ao inv\\u00e9s da sintaxe de v\\u00edrgula (sintaxe validada)\\r\\n-- - Simplificado: Cria diretamente a tabela base sem tabela tempor\\u00e1ria\\r\\n-- - Otimizado: Baseado no c\\u00f3digo que funcionou fornecido pelo usu\\u00e1rio\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1. TABELA BASE: EXTRA\\u00c7\\u00c3O E FLATTENING COM SINTAXE VALIDADA\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_nfce_base_extraida;\\r\\nCREATE TABLE niat.argos_nfce_base_extraida STORED AS PARQUET AS\\r\\nSELECT\\r\\n    -- Campos do cabe\\u00e7alho da nota\\r\\n    a.procnfe.nfe.infnfe.emit.cnpj AS cnpj_emitente,\\r\\n    -- Cria\\u00e7\\u00e3o do Per\\u00edodo\\r\\n    CONCAT(CAST(a.ano_emissao AS STRING), LPAD(CAST(a.mes_emissao AS STRING), 2, '0')) AS periodo,\\r\\n    -- Campos do Produto (extra\\u00eddos diretamente do item desaninhado 'd')\\r\\n    CASE\\r\\n        WHEN d.prod.cean IS NULL OR d.prod.cean = '' OR NOT d.prod.cean RLIKE '^[0-9]+$' THEN 'SEM GTIN'\\r\\n        ELSE REGEXP_REPLACE(d.prod.cean, '^0+', '')\\r\\n    END AS gtin,\\r\\n    d.prod.ncm AS ncm,\\r\\n    TRIM(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(d.prod.xprod), '\\\\\\\\s*[-./\\\\\\\\|!@&+(){}$%=,#?\\u00ba\\u00aa\\u00b0;<>:\\\"]+\\\\\\\\s*', ' '),  '\\\\\\\\s{2,}', ' ')) AS descricao,\\r\\n    -- Base de C\\u00e1lculo\\r\\n    (COALESCE(d.prod.vprod, 0) + COALESCE(d.prod.vfrete, 0) + COALESCE(d.prod.vseg, 0) + COALESCE(d.prod.voutro, 0) - COALESCE(d.prod.vdesc, 0)) AS bc_fisco,\\r\\n    -- Al\\u00edquota do Emitente (tentando diferentes estruturas de ICMS)\\r\\n    COALESCE(\\r\\n        d.imposto.icms.resumo.picms,\\r\\n        d.imposto.icms.icms00.picms,\\r\\n        d.imposto.icms.icms10.picms,\\r\\n        d.imposto.icms.icms20.picms,\\r\\n        d.imposto.icms.icms90.picms,\\r\\n        0\\r\\n    ) / 100.0 AS aliquota_emitente,\\r\\n    \\r\\n    -- Valor do ICMS (tentando diferentes estruturas de ICMS)\\r\\n    COALESCE(\\r\\n        d.imposto.icms.resumo.vicms,\\r\\n        d.imposto.icms.icms00.vicms,\\r\\n        d.imposto.icms.icms10.vicms,\\r\\n        d.imposto.icms.icms20.vicms,\\r\\n        d.imposto.icms.icms90.vicms,\\r\\n        0\\r\\n    ) AS icms_emitente\\r\\nFROM\\r\\n    -- Tabela principal com alias 'a'\\r\\n    nfce.nfce a\\r\\n    -- Desaninhamento (unnest) do array 'det' com alias 'd' usando CROSS JOIN\\r\\n    CROSS JOIN a.procnfe.nfe.infnfe.det d\\r\\n    -- Filtro inicial para performance, juntando com os CNPJs de interesse\\r\\n    INNER JOIN niat.argos_cnpj fiscalizadas ON a.procnfe.nfe.infnfe.emit.cnpj = fiscalizadas.cnpj\\r\\nWHERE\\r\\n    -- Filtros da regra de neg\\u00f3cio\\r\\n    a.ano_emissao IN (2023, 2024, 2025)\\r\\n    AND a.situacao = 1\\r\\n    AND a.procnfe.nfe.infnfe.ide.tpnf = 1 -- 1=Sa\\u00edda\\r\\n    AND a.procnfe.nfe.infnfe.ide.finnfe = 1 -- 1=NF-e Normal\\r\\n    AND a.procnfe.nfe.infnfe.emit.crt <> 1; -- Exclui Simples Nacional\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2. TABELA DE PER\\u00cdODO: AL\\u00cdQUOTA PONDERADA E ENRIQUECIMENTO COM IA\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_nfce_periodo_base;\\r\\nCREATE TABLE niat.argos_nfce_periodo_base STORED AS PARQUET AS\\r\\nWITH ponderacao AS (\\r\\n    SELECT\\r\\n        periodo,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        SUM(aliquota_emitente * bc_fisco) AS total_aliquota_ponderada,\\r\\n        SUM(bc_fisco) AS bc_total_periodo,\\r\\n        SUM(icms_emitente) as icms_total_emitente\\r\\n    FROM niat.argos_nfce_base_extraida\\r\\n    WHERE bc_fisco > 0\\r\\n    GROUP BY periodo, cnpj_emitente, gtin, ncm, descricao\\r\\n)\\r\\nSELECT\\r\\n    p.periodo,\\r\\n    p.cnpj_emitente,\\r\\n    p.gtin,\\r\\n    p.ncm,\\r\\n    p.descricao,\\r\\n    p.bc_total_periodo,\\r\\n    p.icms_total_emitente,\\r\\n    p.total_aliquota_ponderada / p.bc_total_periodo AS aliquota_emitente_media_ponderada,\\r\\n    COALESCE(ia_gtin.aliquota_ia, ia_ncm.aliquota_ia) AS aliquota_ia\\r\\nFROM ponderacao p\\r\\nLEFT JOIN niat.tabela_niat ia_gtin ON p.gtin = ia_gtin.gtin AND p.gtin <> 'SEM GTIN'\\r\\nLEFT JOIN niat.tabela_niat ia_ncm ON p.ncm = ia_ncm.ncm AND p.descricao = ia_ncm.descricao AND p.gtin = 'SEM GTIN';\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3. C\\u00c1LCULO DAS M\\u00c9DIAS HIST\\u00d3RICAS POR EMPRESA E PRODUTO\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_medias_historicas_produto;\\r\\nCREATE TABLE niat.argos_medias_historicas_produto STORED AS PARQUET AS\\r\\nSELECT\\r\\n  cnpj_emitente, gtin, ncm, descricao, aliquota_ia,\\r\\n  COUNT(DISTINCT periodo) AS qtd_periodos_produto,\\r\\n  AVG(aliquota_emitente_media_ponderada) AS aliq_emitente_media_historica,\\r\\n  STDDEV(aliquota_emitente_media_ponderada) AS aliq_emitente_desvio_historico\\r\\nFROM niat.argos_nfce_periodo_base\\r\\nGROUP BY cnpj_emitente, gtin, ncm, descricao, aliquota_ia\\r\\nHAVING COUNT(DISTINCT periodo) >= 3;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4. AN\\u00c1LISE DE MUDAN\\u00c7A DE COMPORTAMENTO POR PER\\u00cdODO\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS niat.argos_mudanca_comportamento;\\r\\nCREATE TABLE niat.argos_mudanca_comportamento STORED AS PARQUET AS\\r\\nSELECT\\r\\n  bp.periodo, bp.cnpj_emitente, c.nm_razao_social, bp.gtin, bp.ncm, bp.descricao,\\r\\n  bp.aliquota_ia,\\r\\n  bp.aliquota_emitente_media_ponderada AS aliq_emitente_periodo,\\r\\n  bp.bc_total_periodo,\\r\\n  mh.aliq_emitente_media_historica,\\r\\n  mh.aliq_emitente_desvio_historico,\\r\\n  \\r\\n  (bp.aliquota_emitente_media_ponderada - mh.aliq_emitente_media_historica) AS diferenca_vs_media_historica,\\r\\n  (bp.aliquota_emitente_media_ponderada - bp.aliquota_ia) AS diferenca_vs_ia_periodo,\\r\\n  (mh.aliq_emitente_media_historica - bp.aliquota_ia) AS diferenca_vs_ia_historica,\\r\\n  \\r\\n  CASE\\r\\n    WHEN mh.aliq_emitente_desvio_historico IS NULL OR mh.aliq_emitente_desvio_historico = 0 THEN 'PRODUTO_ESTAVEL'\\r\\n    WHEN ABS(bp.aliquota_emitente_media_ponderada - mh.aliq_emitente_media_historica) > (2 * mh.aliq_emitente_desvio_historico) THEN 'MUDANCA_EXTREMA'\\r\\n    WHEN ABS(bp.aliquota_emitente_media_ponderada - mh.aliq_emitente_media_historica) > mh.aliq_emitente_desvio_historico THEN 'MUDANCA_SIGNIFICATIVA'\\r\\n    ELSE 'COMPORTAMENTO_NORMAL'\\r\\n  END AS classificacao_mudanca,\\r\\n  \\r\\n  CASE\\r\\n    WHEN bp.aliquota_ia IS NULL THEN 'SEM_REFERENCIA_IA'\\r\\n    WHEN ABS(bp.aliquota_emitente_media_ponderada - bp.aliquota_ia) < ABS(mh.aliq_emitente_media_historica - bp.aliquota_ia) THEN 'APROXIMOU_DA_CORRETA'\\r\\n    WHEN ABS(bp.aliquota_emitente_media_ponderada - bp.aliquota_ia) > ABS(mh.aliq_emitente_media_historica - bp.aliquota_ia) THEN 'AFASTOU_DA_CORRETA'\\r\\n    ELSE 'MANTEVE_DISTANCIA'\\r\\n  END AS movimento_vs_ia\\r\\n\\r\\nFROM niat.argos_nfce_periodo_base bp\\r\\nINNER JOIN niat.argos_medias_historicas_produto mh \\r\\n    ON bp.cnpj_emitente = mh.cnpj_emitente \\r\\n    AND bp.gtin = mh.gtin \\r\\n    AND bp.ncm = mh.ncm \\r\\n    AND bp.descricao = mh.descricao\\r\\nLEFT JOIN usr_sat_ods.vw_ods_contrib c ON bp.cnpj_emitente = c.nu_cnpj;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 5. VIEW FINAL PARA AN\\u00c1LISE E CONSULTA\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP VIEW IF EXISTS niat.argos_vw_evolucao_nfce;\\r\\nCREATE VIEW niat.argos_vw_evolucao_nfce AS\\r\\nSELECT\\r\\n    periodo,\\r\\n    cnpj_emitente,\\r\\n    nm_razao_social,\\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    ROUND(aliq_emitente_periodo * 100, 2) AS aliquota_praticada_pct,\\r\\n    ROUND(aliq_emitente_media_historica * 100, 2) AS aliquota_historica_pct,\\r\\n    ROUND(aliquota_ia * 100, 2) AS aliquota_correta_ia_pct,\\r\\n    classificacao_mudanca,\\r\\n    movimento_vs_ia,\\r\\n    bc_total_periodo\\r\\nFROM niat.argos_mudanca_comportamento\\r\\nORDER BY cnpj_emitente, descricao, periodo;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 6. CONSULTAS DE VERIFICA\\u00c7\\u00c3O E EXEMPLO DE USO\\r\\n-- ----------------------------------------------------------------------------\\r\\n\\r\\n-- Estat\\u00edsticas gerais do sistema\\r\\nSELECT \\r\\n    'Tabela Base' as tabela,\\r\\n    COUNT(*) as total_registros,\\r\\n    COUNT(DISTINCT cnpj_emitente) as empresas_distintas,\\r\\n    COUNT(DISTINCT periodo) as periodos_distintos,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) as produtos_distintos\\r\\nFROM niat.argos_nfce_base_extraida\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'View Final' as tabela,\\r\\n    COUNT(*) as total_registros,\\r\\n    COUNT(DISTINCT cnpj_emitente) as empresas_distintas,\\r\\n    COUNT(DISTINCT periodo) as periodos_distintos,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) as produtos_distintos\\r\\nFROM niat.argos_vw_evolucao_nfce;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- CONSULTAS ANAL\\u00cdTICAS DE EXEMPLO\\r\\n-- ----------------------------------------------------------------------------\\r\\n\\r\\n-- 1. Top 10 empresas com maior n\\u00famero de mudan\\u00e7as extremas em 2024\\r\\nSELECT \\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    COUNT(*) as total_mudancas_extremas,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) as produtos_afetados,\\r\\n    SUM(bc_total_periodo) as base_calculo_total\\r\\nFROM niat.argos_vw_evolucao_nfce\\r\\nWHERE classificacao_mudanca = 'MUDANCA_EXTREMA'\\r\\n  AND LEFT(periodo, 4) = '2024'\\r\\nGROUP BY nm_razao_social, cnpj_emitente\\r\\nORDER BY total_mudancas_extremas DESC\\r\\nLIMIT 10;\\r\\n\\r\\n-- 2. An\\u00e1lise de tend\\u00eancia por per\\u00edodo (\\u00faltimos 6 meses)\\r\\nSELECT \\r\\n    periodo,\\r\\n    COUNT(*) as total_casos,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) as mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) as mudancas_significativas,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) as afastou_da_correta,\\r\\n    SUM(bc_total_periodo) as base_calculo_total\\r\\nFROM niat.argos_vw_evolucao_nfce\\r\\nWHERE periodo >= '202409'  -- \\u00daltimos 6 meses a partir de 2024-09\\r\\nGROUP BY periodo\\r\\nORDER BY periodo DESC;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 223, \"column\": 22}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 664da2c84f455cd9:31f7cf3500000000 100% Complete (44 out of 44)\\\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY cnpj_emitente ASC, descricao ASC, periodo ASC.\\\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"664da2c84f455cd9:31f7cf3500000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=664da2c84f455cd9:31f7cf3500000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 664da2c84f455cd9:31f7cf3500000000 100% Complete (44 out of 44)\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY cnpj_emitente ASC, descricao ASC, periodo ASC.\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\", \"progress\": 100, \"jobs\": [{\"name\": \"664da2c84f455cd9:31f7cf3500000000\", \"url\": \"/hue/jobbrowser#!id=664da2c84f455cd9:31f7cf3500000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 12043.87778, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 101, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- SISTEMA DE ANÁLISE DE COMPORTAMENTO TRIBUTÁRIO POR PRODUTO - V4.0 (VERSÃO FINAL)\r\n-- Fonte de Dados: nfce.nfce (dados originais aninhados)  \r\n-- Foco: Variação da alíquota ponderada para empresas fiscalizadas (niat.argos_cnpj)\r\n-- ============================================================================\r\n-- MELHORIAS V4.0:\r\n-- - CORRIGIDO: Usa CROSS JOIN ao invés da sintaxe de vírgula (sintaxe validada)\r\n-- - Simplificado: Cria diretamente a tabela base sem tabela temporária\r\n-- - Otimizado: Baseado no código que funcionou fornecido pelo usuário\r\n-- ============================================================================\r\n\r\n-- ----------------------------------------------------------------------------\r\n-- 1. TABELA BASE: EXTRAÇÃO E FLATTENING COM SINTAXE VALIDADA\r\n-- ----------------------------------------------------------------------------\r\nDROP TABLE IF EXISTS niat.argos_nfce_base_extraida;\r\nCREATE TABLE niat.argos_nfce_base_extraida STORED AS PARQUET AS\r\nSELECT\r\n    -- Campos do cabeçalho da nota\r\n    a.procnfe.nfe.infnfe.emit.cnpj AS cnpj_emitente,\r\n    -- Criação do Período\r\n    CONCAT(CAST(a.ano_emissao AS STRING), LPAD(CAST(a.mes_emissao AS STRING), 2, '0')) AS periodo,\r\n    -- Campos do Produto (extraídos diretamente do item desaninhado 'd')\r\n    CASE\r\n        WHEN d.prod.cean IS NULL OR d.prod.cean = '' OR NOT d.prod.cean RLIKE '^[0-9]+$' THEN 'SEM GTIN'\r\n        ELSE REGEXP_REPLACE(d.prod.cean, '^0+', '')\r\n    END AS gtin,\r\n    d.prod.ncm AS ncm,\r\n    TRIM(REGEXP_REPLACE(REGEXP_REPLACE(UPPER(d.prod.xprod), '\\\\s*[-./\\\\|!@&+(){}$%=,#?ºª°;<>:\"]+\\\\s*', ' '),  '\\\\s{2,}', ' ')) AS descricao,\r\n    -- Base de Cálculo\r\n    (COALESCE(d.prod.vprod, 0) + COALESCE(d.prod.vfrete, 0) + COALESCE(d.prod.vseg, 0) + COALESCE(d.prod.voutro, 0) - COALESCE(d.prod.vdesc, 0)) AS bc_fisco,\r\n    -- Alíquota do Emitente (tentando diferentes estruturas de ICMS)\r\n    COALESCE(\r\n        d.impo",
    "last_modified": "2025-10-03T15:06:14.106",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "9c31952e-c6b2-404c-9369-a01b5cd73495",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 153926,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "ARGOS INDIVIDUAL",
    "description": "",
    "uuid": "9c31952e-c6b2-404c-9369-a01b5cd73495",
    "type": "directory",
    "connector": null,
    "data": "{}",
    "extra": "",
    "search": null,
    "last_modified": "2025-09-12T15:22:34.919",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a8280168-7cf2-40b1-bc5d-733014ae6ba9",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 154350,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "ARGOS: Análise Empresa CONSULTA",
    "description": "",
    "uuid": "cd78332b-77a8-0ee1-1d98-07300c985fba",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 154350, \"uuid\": \"54b785d5-07cf-41ed-94e2-ac64084def1a\", \"name\": \"ARGOS: An\\u00e1lise Empresa CONSULTA\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"cd78332b-77a8-0ee1-1d98-07300c985fba\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"29f6a03e-0996-fb0a-2513-0e910046f186\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 56, \"column\": 39}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 2, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- =================================================================================================\\r\\n-- QUERY 1: Detalhamento por empresa/produto\\r\\n-- =================================================================================================\\r\\nWITH ranked_mudancas AS (\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        ROW_NUMBER() OVER(PARTITION BY cnpj_emitente, gtin, ncm, descricao ORDER BY periodo ASC) as rn\\r\\n    FROM niat.argos_vw_evolucao_nfce\\r\\n    WHERE classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA')\\r\\n),\\r\\ncalculo_final AS (\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        (aliquota_praticada_pct / 100.0 - aliquota_historica_pct / 100.0) * bc_total_periodo AS diferenca_financeira_estimada\\r\\n    FROM ranked_mudancas\\r\\n    WHERE rn = 1\\r\\n        AND aliquota_praticada_pct > aliquota_historica_pct\\r\\n)\\r\\nSELECT\\r\\n    '1. Detalhamento por Empresa/Produto' AS tipo_consulta, -- ADICIONAR IDENTIFICADOR\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao AS nome_do_produto,\\r\\n    periodo AS primeiro_mes_da_mudanca,\\r\\n    REPLACE(CAST(ROUND(aliquota_historica_pct, 2) AS STRING), '.', ',') AS aliquota_antiga_media,\\r\\n    REPLACE(CAST(ROUND(aliquota_praticada_pct, 2) AS STRING), '.', ',') AS aliquota_nova_praticada,\\r\\n    REPLACE(CAST(ROUND(aliquota_correta_ia_pct / 100.0, 2) AS STRING), '.', ',') AS aliquota_referencia_ia,\\r\\n    REPLACE(CAST(ROUND(bc_total_periodo, 2) AS STRING), '.', ',') AS valor_total_vendido_no_mes,\\r\\n    REPLACE(CAST(ROUND(diferenca_financeira_estimada, 2) AS STRING), '.', ',') AS diferenca_financeira_estimada\\r\\nFROM calculo_final\\r\\nORDER BY diferenca_financeira_estimada DESC;\\r\\n\\r\\n\\r\\n-- =================================================================================================\\r\\n-- QUERY 2: Agrega\\u00e7\\u00e3o por per\\u00edodo\\r\\n-- =================================================================================================\\r\\nWITH ranked_mudancas AS (\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        ROW_NUMBER() OVER(PARTITION BY cnpj_emitente, gtin, ncm, descricao ORDER BY periodo ASC) as rn\\r\\n    FROM niat.argos_vw_evolucao_nfce\\r\\n    WHERE classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA')\\r\\n),\\r\\ncalculo_final AS (\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        (aliquota_praticada_pct / 100.0 - aliquota_historica_pct / 100.0) * bc_total_periodo AS diferenca_financeira_estimada\\r\\n    FROM ranked_mudancas\\r\\n    WHERE rn = 1\\r\\n        AND aliquota_praticada_pct > aliquota_historica_pct\\r\\n)\\r\\nSELECT\\r\\n    '2. Agrega\\u00e7\\u00e3o por Per\\u00edodo' AS tipo_consulta, -- ADICIONAR IDENTIFICADOR\\r\\n    periodo AS periodo_mudanca,\\r\\n    COUNT(*) AS qtd_eventos_mudanca,\\r\\n    COUNT(DISTINCT cnpj_emitente) AS qtd_empresas_distintas,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS qtd_produtos_distintos,\\r\\n    ROUND(AVG(aliquota_historica_pct), 2) AS aliq_historica_media,\\r\\n    ROUND(AVG(aliquota_praticada_pct), 2) AS aliq_praticada_media,\\r\\n    ROUND(AVG(aliquota_correta_ia_pct / 100.0), 2) AS aliq_ia_media,\\r\\n    ROUND(AVG(aliquota_praticada_pct - aliquota_historica_pct), 2) AS variacao_aliq_media,\\r\\n    ROUND(SUM(bc_total_periodo), 2) AS bc_total_periodo_agregada,\\r\\n    ROUND(AVG(bc_total_periodo), 2) AS bc_media_por_evento,\\r\\n    ROUND(SUM(diferenca_financeira_estimada), 2) AS diferenca_financeira_total,\\r\\n    ROUND(AVG(diferenca_financeira_estimada), 2) AS diferenca_financeira_media,\\r\\n    ROUND(SUM(diferenca_financeira_estimada) / COUNT(DISTINCT cnpj_emitente), 2) AS impacto_medio_por_empresa,\\r\\n    ROUND(SUM(CASE WHEN aliquota_praticada_pct - aliquota_historica_pct > 5 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS pct_variacoes_acima_5pp,\\r\\n    ROUND(SUM(CASE WHEN diferenca_financeira_estimada > 10000 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS pct_impacto_alto\\r\\nFROM calculo_final\\r\\nGROUP BY periodo\\r\\nORDER BY periodo DESC;\", \"statementsList\": [\"-- =================================================================================================\\r\\n-- QUERY 1: Detalhamento por empresa/produto\\r\\n-- =================================================================================================\\r\\nWITH ranked_mudancas AS (\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        ROW_NUMBER() OVER(PARTITION BY cnpj_emitente, gtin, ncm, descricao ORDER BY periodo ASC) as rn\\r\\n    FROM niat.argos_vw_evolucao_nfce\\r\\n    WHERE classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA')\\r\\n),\\r\\ncalculo_final AS (\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        (aliquota_praticada_pct / 100.0 - aliquota_historica_pct / 100.0) * bc_total_periodo AS diferenca_financeira_estimada\\r\\n    FROM ranked_mudancas\\r\\n    WHERE rn = 1\\r\\n        AND aliquota_praticada_pct > aliquota_historica_pct\\r\\n)\\r\\nSELECT\\r\\n    '1. Detalhamento por Empresa/Produto' AS tipo_consulta, -- ADICIONAR IDENTIFICADOR\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao AS nome_do_produto,\\r\\n    periodo AS primeiro_mes_da_mudanca,\\r\\n    REPLACE(CAST(ROUND(aliquota_historica_pct, 2) AS STRING), '.', ',') AS aliquota_antiga_media,\\r\\n    REPLACE(CAST(ROUND(aliquota_praticada_pct, 2) AS STRING), '.', ',') AS aliquota_nova_praticada,\\r\\n    REPLACE(CAST(ROUND(aliquota_correta_ia_pct / 100.0, 2) AS STRING), '.', ',') AS aliquota_referencia_ia,\\r\\n    REPLACE(CAST(ROUND(bc_total_periodo, 2) AS STRING), '.', ',') AS valor_total_vendido_no_mes,\\r\\n    REPLACE(CAST(ROUND(diferenca_financeira_estimada, 2) AS STRING), '.', ',') AS diferenca_financeira_estimada\\r\\nFROM calculo_final\\r\\nORDER BY diferenca_financeira_estimada DESC;\", \"\\r\\n\\r\\n\\r\\n-- =================================================================================================\\r\\n-- QUERY 2: Agrega\\u00e7\\u00e3o por per\\u00edodo\\r\\n-- =================================================================================================\\r\\nWITH ranked_mudancas AS (\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        ROW_NUMBER() OVER(PARTITION BY cnpj_emitente, gtin, ncm, descricao ORDER BY periodo ASC) as rn\\r\\n    FROM niat.argos_vw_evolucao_nfce\\r\\n    WHERE classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA')\\r\\n),\\r\\ncalculo_final AS (\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        (aliquota_praticada_pct / 100.0 - aliquota_historica_pct / 100.0) * bc_total_periodo AS diferenca_financeira_estimada\\r\\n    FROM ranked_mudancas\\r\\n    WHERE rn = 1\\r\\n        AND aliquota_praticada_pct > aliquota_historica_pct\\r\\n)\\r\\nSELECT\\r\\n    '2. Agrega\\u00e7\\u00e3o por Per\\u00edodo' AS tipo_consulta, -- ADICIONAR IDENTIFICADOR\\r\\n    periodo AS periodo_mudanca,\\r\\n    COUNT(*) AS qtd_eventos_mudanca,\\r\\n    COUNT(DISTINCT cnpj_emitente) AS qtd_empresas_distintas,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS qtd_produtos_distintos,\\r\\n    ROUND(AVG(aliquota_historica_pct), 2) AS aliq_historica_media,\\r\\n    ROUND(AVG(aliquota_praticada_pct), 2) AS aliq_praticada_media,\\r\\n    ROUND(AVG(aliquota_correta_ia_pct / 100.0), 2) AS aliq_ia_media,\\r\\n    ROUND(AVG(aliquota_praticada_pct - aliquota_historica_pct), 2) AS variacao_aliq_media,\\r\\n    ROUND(SUM(bc_total_periodo), 2) AS bc_total_periodo_agregada,\\r\\n    ROUND(AVG(bc_total_periodo), 2) AS bc_media_por_evento,\\r\\n    ROUND(SUM(diferenca_financeira_estimada), 2) AS diferenca_financeira_total,\\r\\n    ROUND(AVG(diferenca_financeira_estimada), 2) AS diferenca_financeira_media,\\r\\n    ROUND(SUM(diferenca_financeira_estimada) / COUNT(DISTINCT cnpj_emitente), 2) AS impacto_medio_por_empresa,\\r\\n    ROUND(SUM(CASE WHEN aliquota_praticada_pct - aliquota_historica_pct > 5 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS pct_variacoes_acima_5pp,\\r\\n    ROUND(SUM(CASE WHEN diferenca_financeira_estimada > 10000 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS pct_impacto_alto\\r\\nFROM calculo_final\\r\\nGROUP BY periodo\\r\\nORDER BY periodo DESC;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\n\\r\\n-- =================================================================================================\\r\\n-- QUERY 2: Agrega\\u00e7\\u00e3o por per\\u00edodo\\r\\n-- =================================================================================================\\r\\nWITH ranked_mudancas AS (\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        ROW_NUMBER() OVER(PARTITION BY cnpj_emitente, gtin, ncm, descricao ORDER BY periodo ASC) as rn\\r\\n    FROM niat.argos_vw_evolucao_nfce\\r\\n    WHERE classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA')\\r\\n),\\r\\ncalculo_final AS (\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        (aliquota_praticada_pct / 100.0 - aliquota_historica_pct / 100.0) * bc_total_periodo AS diferenca_financeira_estimada\\r\\n    FROM ranked_mudancas\\r\\n    WHERE rn = 1\\r\\n        AND aliquota_praticada_pct > aliquota_historica_pct\\r\\n)\\r\\nSELECT\\r\\n    '2. Agrega\\u00e7\\u00e3o por Per\\u00edodo' AS tipo_consulta, -- ADICIONAR IDENTIFICADOR\\r\\n    periodo AS periodo_mudanca,\\r\\n    COUNT(*) AS qtd_eventos_mudanca,\\r\\n    COUNT(DISTINCT cnpj_emitente) AS qtd_empresas_distintas,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS qtd_produtos_distintos,\\r\\n    ROUND(AVG(aliquota_historica_pct), 2) AS aliq_historica_media,\\r\\n    ROUND(AVG(aliquota_praticada_pct), 2) AS aliq_praticada_media,\\r\\n    ROUND(AVG(aliquota_correta_ia_pct / 100.0), 2) AS aliq_ia_media,\\r\\n    ROUND(AVG(aliquota_praticada_pct - aliquota_historica_pct), 2) AS variacao_aliq_media,\\r\\n    ROUND(SUM(bc_total_periodo), 2) AS bc_total_periodo_agregada,\\r\\n    ROUND(AVG(bc_total_periodo), 2) AS bc_media_por_evento,\\r\\n    ROUND(SUM(diferenca_financeira_estimada), 2) AS diferenca_financeira_total,\\r\\n    ROUND(AVG(diferenca_financeira_estimada), 2) AS diferenca_financeira_media,\\r\\n    ROUND(SUM(diferenca_financeira_estimada) / COUNT(DISTINCT cnpj_emitente), 2) AS impacto_medio_por_empresa,\\r\\n    ROUND(SUM(CASE WHEN aliquota_praticada_pct - aliquota_historica_pct > 5 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS pct_variacoes_acima_5pp,\\r\\n    ROUND(SUM(CASE WHEN diferenca_financeira_estimada > 10000 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 1) AS pct_impacto_alto\\r\\nFROM calculo_final\\r\\nGROUP BY periodo\\r\\nORDER BY periodo DESC;\", \"result\": {\"id\": \"ae155d43-8436-135f-b9d9-edca3076de3c\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"292mAm/eTAm5KKIecqdyQA==\", \"guid\": \"I7EGjxi4SxsAAAAANvSxXQ==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"fd4c9a438f9ef517:77fd0a436d49ccbf\", \"session_id\": 21216, \"session_type\": \"impala\", \"statement_id\": 0, \"has_more_statements\": false, \"statements_count\": 1, \"previous_statement_hash\": \"d17efc6a3a77d2d843b157647458ef8c39874718d35ab14e4948cda6\", \"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 2304}, \"statement\": \"WITH ranked_mudancas AS (\\r\\n    -- Etapa 1: Encontrar todas as mudan\\u00e7as e atribuir um ranking baseado na data\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin, -- COLUNA ADICIONADA\\r\\n        ncm,  -- COLUNA ADICIONADA\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        -- PARTITION BY ATUALIZADO para incluir gtin e ncm, garantindo a unicidade do produto\\r\\n        ROW_NUMBER() OVER(PARTITION BY cnpj_emitente, gtin, ncm, descricao ORDER BY periodo ASC) as rn\\r\\n    FROM\\r\\n        niat.argos_vw_evolucao_nfce -- O nome da view foi corrigido conforme seu \\u00faltimo c\\u00f3digo\\r\\n    WHERE\\r\\n        classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA')\\r\\n),\\r\\ncalculo_final AS (\\r\\n    -- Etapa 2: Selecionar o primeiro m\\u00eas da mudan\\u00e7a e CALCULAR a diferen\\u00e7a\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin, -- COLUNA ADICIONADA\\r\\n        ncm,  -- COLUNA ADICIONADA\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        (aliquota_praticada_pct / 100.0 - aliquota_historica_pct / 100.0) * bc_total_periodo AS diferenca_financeira_estimada\\r\\n    FROM\\r\\n        ranked_mudancas\\r\\n    WHERE\\r\\n        rn = 1\\r\\n        AND aliquota_praticada_pct > aliquota_historica_pct\\r\\n)\\r\\n-- Etapa 3: Selecionar os resultados finais, FORMATAR e ORDENAR\\r\\nSELECT\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    gtin, -- COLUNA ADICIONADA\\r\\n    ncm,  -- COLUNA ADICIONADA\\r\\n    descricao AS nome_do_produto,\\r\\n    periodo AS primeiro_mes_da_mudanca,\\r\\n    REPLACE(CAST(ROUND(aliquota_historica_pct, 2) AS STRING), '.', ',') AS aliquota_antiga_media,\\r\\n    REPLACE(CAST(ROUND(aliquota_praticada_pct, 2) AS STRING), '.', ',') AS aliquota_nova_praticada,\\r\\n    REPLACE(CAST(ROUND(aliquota_correta_ia_pct / 100.0, 2) AS STRING), '.', ',') AS aliquota_referencia_ia,\\r\\n    REPLACE(CAST(ROUND(bc_total_periodo, 2) AS STRING), '.', ',') AS valor_total_vendido_no_mes,\\r\\n    REPLACE(CAST(ROUND(diferenca_financeira_estimada, 2) AS STRING), '.', ',') AS diferenca_financeira_estimada\\r\\nFROM\\r\\n    calculo_final\\r\\nORDER BY\\r\\n    diferenca_financeira_estimada DESC\"}, \"meta\": [], \"rows\": 4059, \"hasMore\": true, \"statement_id\": 0, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 1, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 11, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"nm_razao_social\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}, {\"name\": \"cnpj_emitente\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 2}, {\"name\": \"gtin\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 3}, {\"name\": \"ncm\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 4}, {\"name\": \"nome_do_produto\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 5}, {\"name\": \"primeiro_mes_da_mudanca\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 6}, {\"name\": \"aliquota_antiga_media\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 7}, {\"name\": \"aliquota_nova_praticada\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 8}, {\"name\": \"aliquota_referencia_ia\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 9}, {\"name\": \"valor_total_vendido_no_mes\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 10}, {\"name\": \"diferenca_financeira_estimada\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 11}], \"fetchedOnce\": false, \"startTime\": \"2025-10-03T20:59:39.376Z\", \"endTime\": \"2025-10-03T20:59:41.883Z\", \"executionTime\": 2507, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 15, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"nm_razao_social\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"nm_razao_social\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 8847, \"getLogsTimeout\": 8936, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1759525179066, \"lastAceSelectionRowOffset\": 0, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"WITH ranked_mudancas AS (\\r\\n    -- Etapa 1: Encontrar todas as mudan\\u00e7as e atribuir um ranking baseado na data\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin, -- COLUNA ADICIONADA\\r\\n        ncm,  -- COLUNA ADICIONADA\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        -- PARTITION BY ATUALIZADO para incluir gtin e ncm, garantindo a unicidade do produto\\r\\n        ROW_NUMBER() OVER(PARTITION BY cnpj_emitente, gtin, ncm, descricao ORDER BY periodo ASC) as rn\\r\\n    FROM\\r\\n        niat.argos_vw_evolucao_nfce -- O nome da view foi corrigido conforme seu \\u00faltimo c\\u00f3digo\\r\\n    WHERE\\r\\n        classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA')\\r\\n),\\r\\ncalculo_final AS (\\r\\n    -- Etapa 2: Selecionar o primeiro m\\u00eas da mudan\\u00e7a e CALCULAR a diferen\\u00e7a\\r\\n    SELECT\\r\\n        nm_razao_social,\\r\\n        cnpj_emitente,\\r\\n        gtin, -- COLUNA ADICIONADA\\r\\n        ncm,  -- COLUNA ADICIONADA\\r\\n        descricao,\\r\\n        periodo,\\r\\n        aliquota_historica_pct,\\r\\n        aliquota_praticada_pct,\\r\\n        bc_total_periodo,\\r\\n        aliquota_correta_ia_pct,\\r\\n        (aliquota_praticada_pct / 100.0 - aliquota_historica_pct / 100.0) * bc_total_periodo AS diferenca_financeira_estimada\\r\\n    FROM\\r\\n        ranked_mudancas\\r\\n    WHERE\\r\\n        rn = 1\\r\\n        AND aliquota_praticada_pct > aliquota_historica_pct\\r\\n)\\r\\n-- Etapa 3: Selecionar os resultados finais, FORMATAR e ORDENAR\\r\\nSELECT\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    gtin, -- COLUNA ADICIONADA\\r\\n    ncm,  -- COLUNA ADICIONADA\\r\\n    descricao AS nome_do_produto,\\r\\n    periodo AS primeiro_mes_da_mudanca,\\r\\n    REPLACE(CAST(ROUND(aliquota_historica_pct, 2) AS STRING), '.', ',') AS aliquota_antiga_media,\\r\\n    REPLACE(CAST(ROUND(aliquota_praticada_pct, 2) AS STRING), '.', ',') AS aliquota_nova_praticada,\\r\\n    REPLACE(CAST(ROUND(aliquota_correta_ia_pct / 100.0, 2) AS STRING), '.', ',') AS aliquota_referencia_ia,\\r\\n    REPLACE(CAST(ROUND(bc_total_periodo, 2) AS STRING), '.', ',') AS valor_total_vendido_no_mes,\\r\\n    REPLACE(CAST(ROUND(diferenca_financeira_estimada, 2) AS STRING), '.', ',') AS diferenca_financeira_estimada\\r\\nFROM\\r\\n    calculo_final\\r\\nORDER BY\\r\\n    diferenca_financeira_estimada DESC;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 56, \"column\": 39}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 1b4bb8188f06b123:5db1f43600000000: 87% Complete (7 out of 8)\\\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY cnpj_emitente ASC, descricao ASC, periodo ASC.\\\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"1b4bb8188f06b123:5db1f43600000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=1b4bb8188f06b123:5db1f43600000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 1b4bb8188f06b123:5db1f43600000000: 87% Complete (7 out of 8)\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY cnpj_emitente ASC, descricao ASC, periodo ASC.\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\", \"progress\": 100, \"jobs\": [{\"name\": \"1b4bb8188f06b123:5db1f43600000000\", \"url\": \"/hue/jobbrowser#!id=1b4bb8188f06b123:5db1f43600000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 7821.52778, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 101, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- =================================================================================================\r\n-- QUERY 1: Detalhamento por empresa/produto\r\n-- =================================================================================================\r\nWITH ranked_mudancas AS (\r\n    SELECT\r\n        nm_razao_social,\r\n        cnpj_emitente,\r\n        gtin,\r\n        ncm,\r\n        descricao,\r\n        periodo,\r\n        aliquota_historica_pct,\r\n        aliquota_praticada_pct,\r\n        bc_total_periodo,\r\n        aliquota_correta_ia_pct,\r\n        ROW_NUMBER() OVER(PARTITION BY cnpj_emitente, gtin, ncm, descricao ORDER BY periodo ASC) as rn\r\n    FROM niat.argos_vw_evolucao_nfce\r\n    WHERE classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA')\r\n),\r\ncalculo_final AS (\r\n    SELECT\r\n        nm_razao_social,\r\n        cnpj_emitente,\r\n        gtin,\r\n        ncm,\r\n        descricao,\r\n        periodo,\r\n        aliquota_historica_pct,\r\n        aliquota_praticada_pct,\r\n        bc_total_periodo,\r\n        aliquota_correta_ia_pct,\r\n        (aliquota_praticada_pct / 100.0 - aliquota_historica_pct / 100.0) * bc_total_periodo AS diferenca_financeira_estimada\r\n    FROM ranked_mudancas\r\n    WHERE rn = 1\r\n        AND aliquota_praticada_pct > aliquota_historica_pct\r\n)\r\nSELECT\r\n    '1. Detalhamento por Empresa/Produto' AS tipo_consulta, -- ADICIONAR IDENTIFICADOR\r\n    nm_razao_social,\r\n    cnpj_emitente,\r\n    gtin,\r\n    ncm,\r\n    descricao AS nome_do_produto,\r\n    periodo AS primeiro_mes_da_mudanca,\r\n    REPLACE(CAST(ROUND(aliquota_historica_pct, 2) AS STRING), '.', ',') AS aliquota_antiga_media,\r\n    REPLACE(CAST(ROUND(aliquota_praticada_pct, 2) AS STRING), '.', ',') AS aliquota_nova_praticada,\r\n    REPLACE(CAST(ROUND(aliquota_correta_ia_pct / 100.0, 2) AS STRING), '.', ',') AS aliquota_referencia_ia,\r\n    REPLACE(CAST(ROUND(bc_total_periodo, 2) AS STRING), '.', ',') AS valor_total_vendido_no_mes,\r\n    REPLACE(CAST(ROUND(diferenca_financeira_estimada, 2) AS STRING), '.', ',') AS difer",
    "last_modified": "2025-10-03T18:00:01.838",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "9c31952e-c6b2-404c-9369-a01b5cd73495",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 158452,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "ARGOS: ANALISES",
    "description": "",
    "uuid": "758e3829-9a44-749c-bfc3-f7d1f9221a5c",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 158452, \"uuid\": \"758e3829-9a44-749c-bfc3-f7d1f9221a5c\", \"name\": \"ARGOS: ANALISES\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"2e3c985e-53f8-b752-89c3-3cb91a303cb3\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 255, \"column\": 18}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 1, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"/***************************************************************************************************\\r\\n * =================================================================================================\\r\\n * SCRIPT UNIFICADO DE AN\\u00c1LISE E CONSULTA - SISTEMA ARGOS (An\\u00e1lise de Comportamento Tribut\\u00e1rio)\\r\\n * =================================================================================================\\r\\n *\\r\\n * DESCRI\\u00c7\\u00c3O:\\r\\n * Este script cont\\u00e9m um conjunto completo de consultas prontas para uso que extraem estat\\u00edsticas,\\r\\n * rankings e an\\u00e1lises detalhadas do sistema Argos.\\r\\n *\\r\\n * COMO USAR:\\r\\n * 1. Para as \\\"An\\u00e1lises Completas (Dossi\\u00ea da Empresa)\\\", modifique o CNPJ na cl\\u00e1usula WHERE.\\r\\n * 2. Execute o script completo ou cada consulta individualmente.\\r\\n *\\r\\n * DATA DE GERA\\u00c7\\u00c3O: 01 de Outubro de 2025\\r\\n ***************************************************************************************************/\\r\\n\\r\\n-- =================================================================================================\\r\\n-- SE\\u00c7\\u00c3O 1: ESTAT\\u00cdSTICAS GERAIS DO SISTEMA (VIS\\u00c3O MACRO)\\r\\n-- =================================================================================================\\r\\n\\r\\n-- 1.1. Resumo Quantitativo do Ambiente Argos\\r\\n-- Objetivo: Obter as contagens totais de empresas, produtos, per\\u00edodos e eventos de mudan\\u00e7a monitorados.\\r\\nSELECT\\r\\n    '1.1. Resumo Quantitativo do Ambiente Argos' AS consulta,\\r\\n    COUNT(DISTINCT cnpj_emitente) AS total_empresas_analisadas,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm, '-', descricao)) AS total_produtos_unicos_com_mudanca,\\r\\n    COUNT(DISTINCT periodo) AS total_periodos_com_mudanca,\\r\\n    COUNT(*) AS total_eventos_de_mudanca_registrados -- (Cada linha na view \\u00e9 um evento empresa-produto-m\\u00eas)\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce;\\r\\n\\r\\n\\r\\n-- 1.2. Distribui\\u00e7\\u00e3o das Mudan\\u00e7as por Classifica\\u00e7\\u00e3o de Risco\\r\\n-- Objetivo: Entender o volume de cada tipo de mudan\\u00e7a de comportamento.\\r\\nSELECT\\r\\n    '1.2. Distribui\\u00e7\\u00e3o das Mudan\\u00e7as por Classifica\\u00e7\\u00e3o de Risco' AS consulta,\\r\\n    classificacao_mudanca,\\r\\n    COUNT(*) AS quantidade_de_eventos,\\r\\n    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM niat.argos_vw_evolucao_nfce), 2) AS percentual_total\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nGROUP BY\\r\\n    classificacao_mudanca\\r\\nORDER BY\\r\\n    quantidade_de_eventos DESC;\\r\\n\\r\\n\\r\\n-- 1.3. An\\u00e1lise de Qualidade do Movimento (Aproxima\\u00e7\\u00e3o vs. Afastamento da Al\\u00edquota Correta)\\r\\n-- Objetivo: Avaliar se as mudan\\u00e7as est\\u00e3o, em geral, corrigindo ou piorando a tributa\\u00e7\\u00e3o.\\r\\nSELECT\\r\\n    '1.3. An\\u00e1lise de Qualidade do Movimento vs. IA' AS consulta,\\r\\n    movimento_vs_ia,\\r\\n    COUNT(*) AS quantidade_de_eventos,\\r\\n    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM niat.argos_vw_evolucao_nfce WHERE movimento_vs_ia <> 'SEM_REFERENCIA_IA'), 2) AS percentual_dos_casos_com_referencia\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nGROUP BY\\r\\n    movimento_vs_ia\\r\\nORDER BY\\r\\n    quantidade_de_eventos DESC;\\r\\n\\r\\n\\r\\n-- =================================================================================================\\r\\n-- SE\\u00c7\\u00c3O 2: CONSULTAS ANAL\\u00cdTICAS (RANKINGS E PADR\\u00d5ES)\\r\\n-- =================================================================================================\\r\\n\\r\\n-- 2.1. Top 20 Empresas por Volume de Mudan\\u00e7as de Al\\u00edquota (Extremas + Significativas)\\r\\n-- Objetivo: Identificar as empresas com o comportamento tribut\\u00e1rio mais inst\\u00e1vel.\\r\\nSELECT\\r\\n    '2.1. Top 20 Empresas por Volume de Mudan\\u00e7as' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    COUNT(*) AS total_eventos_de_mudanca,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm, '-', descricao)) AS produtos_afetados,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS total_mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) AS total_mudancas_significativas,\\r\\n    SUM(bc_total_periodo) AS valor_total_envolvido_nas_mudancas\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nGROUP BY\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente\\r\\nORDER BY\\r\\n    total_eventos_de_mudanca DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- 2.2. Top 20 Empresas por Impacto Financeiro Potencial\\r\\n-- Objetivo: Listar as empresas cujas mudan\\u00e7as de al\\u00edquota envolveram o maior volume financeiro (base de c\\u00e1lculo).\\r\\nSELECT\\r\\n    '2.2. Top 20 Empresas por Impacto Financeiro Potencial' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    SUM(bc_total_periodo) AS valor_total_envolvido_nas_mudancas,\\r\\n    COUNT(*) AS total_eventos_de_mudanca,\\r\\n    -- Calcula a diferen\\u00e7a m\\u00e9dia de al\\u00edquota para dar contexto\\r\\n    AVG(aliquota_praticada_pct - aliquota_historica_pct) as variacao_media_percentual\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nGROUP BY\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente\\r\\nORDER BY\\r\\n    valor_total_envolvido_nas_mudancas DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- 2.3. Top 20 Produtos com Mudan\\u00e7as Mais Frequentes (em diferentes empresas)\\r\\n-- Objetivo: Identificar produtos que s\\u00e3o foco recorrente de altera\\u00e7\\u00f5es de al\\u00edquota, podendo indicar dificuldade de classifica\\u00e7\\u00e3o fiscal.\\r\\nSELECT\\r\\n    '2.3. Top 20 Produtos com Mudan\\u00e7as Mais Frequentes' AS consulta,\\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    COUNT(*) AS total_eventos_de_mudanca,\\r\\n    COUNT(DISTINCT cnpj_emitente) AS empresas_distintas_com_mudanca\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nGROUP BY\\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao\\r\\nORDER BY\\r\\n    total_eventos_de_mudanca DESC,\\r\\n    empresas_distintas_com_mudanca DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- 2.4. An\\u00e1lise de Tend\\u00eancia Mensal das Mudan\\u00e7as de Comportamento (VERS\\u00c3O CORRIGIDA)\\r\\n-- Objetivo: Observar a evolu\\u00e7\\u00e3o da quantidade e qualidade das mudan\\u00e7as ao longo do tempo.\\r\\nSELECT\\r\\n    '2.4. An\\u00e1lise de Tend\\u00eancia Mensal' AS consulta,\\r\\n    periodo,\\r\\n    COUNT(*) AS total_eventos_de_mudanca,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) as mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) as mudancas_significativas,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS movimentos_de_correcao,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS movimentos_de_piora,\\r\\n    SUM(bc_total_periodo) as valor_total_envolvido_no_mes\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    -- CORRE\\u00c7\\u00c3O APLICADA AQUI \\ud83d\\udc47: Trocado DATE_ADD por ADD_MONTHS\\r\\n    periodo >= DATE_FORMAT(ADD_MONTHS(CURRENT_DATE(), -12), 'yyyyMM') -- Analisa os \\u00faltimos 12 meses.\\r\\nGROUP BY\\r\\n    periodo\\r\\nORDER BY\\r\\n    periodo DESC;\\r\\n\\r\\n\\r\\n-- =================================================================================================\\r\\n-- SE\\u00c7\\u00c3O 3: AN\\u00c1LISES COMPLETAS (DOSSI\\u00ca DA EMPRESA)\\r\\n-- Instru\\u00e7\\u00e3o: Substitua '00000000000000' pelo CNPJ que deseja investigar.\\r\\n-- =================================================================================================\\r\\n\\r\\n-- 3.1. Dossi\\u00ea da Empresa: Vis\\u00e3o Geral e M\\u00e9tricas Chave\\r\\nSELECT\\r\\n    '3.1. Dossi\\u00ea da Empresa - M\\u00e9tricas Consolidadas' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    COUNT(*) AS total_eventos_de_mudanca,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm, '-', descricao)) AS produtos_distintos_afetados,\\r\\n    SUM(bc_total_periodo) AS valor_total_envolvido,\\r\\n    MIN(periodo) AS primeiro_mes_com_mudanca,\\r\\n    MAX(periodo) AS ultimo_mes_com_mudanca,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS total_mudancas_extremas,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS total_movimentos_de_correcao,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS total_movimentos_de_piora\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    cnpj_emitente = '00000000000000' -- << MODIFIQUE AQUI O CNPJ ALVO\\r\\nGROUP BY\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente;\\r\\n\\r\\n\\r\\n-- 3.2. Dossi\\u00ea da Empresa: Detalhe das Mudan\\u00e7as por Produto\\r\\n-- Lista todos os produtos de uma empresa que sofreram altera\\u00e7\\u00f5es, ordenados pelo maior impacto (valor).\\r\\nSELECT\\r\\n    '3.2. Dossi\\u00ea da Empresa - Detalhe das Mudan\\u00e7as por Produto' AS consulta,\\r\\n    periodo,\\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    aliquota_historica_pct,\\r\\n    aliquota_praticada_pct,\\r\\n    aliquota_correta_ia_pct,\\r\\n    classificacao_mudanca,\\r\\n    movimento_vs_ia,\\r\\n    bc_total_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    cnpj_emitente = '00000000000000' -- << MODIFIQUE AQUI O CNPJ ALVO\\r\\nORDER BY\\r\\n    bc_total_periodo DESC,\\r\\n    periodo DESC;\\r\\n\\r\\n\\r\\n-- =================================================================================================\\r\\n-- SE\\u00c7\\u00c3O 4: AN\\u00c1LISES DE RISCO E CEN\\u00c1RIOS ESPEC\\u00cdFICOS\\r\\n-- =================================================================================================\\r\\n\\r\\n-- 4.1. Ranking de \\\"Corre\\u00e7\\u00e3o de Alto Impacto\\\"\\r\\n-- Objetivo: Identificar as corre\\u00e7\\u00f5es de al\\u00edquota mais relevantes financeiramente.\\r\\nSELECT\\r\\n    '4.1. Ranking de Corre\\u00e7\\u00e3o de Alto Impacto' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    periodo,\\r\\n    gtin,\\r\\n    descricao,\\r\\n    aliquota_historica_pct,\\r\\n    aliquota_praticada_pct,\\r\\n    aliquota_correta_ia_pct,\\r\\n    bc_total_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    classificacao_mudanca = 'MUDANCA_EXTREMA'\\r\\n    AND movimento_vs_ia = 'APROXIMOU_DA_CORRETA'\\r\\nORDER BY\\r\\n    bc_total_periodo DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- 4.2. Ranking de \\\"Piora de Alto Impacto\\\" (ALERTA VERMELHO)\\r\\n-- Objetivo: Identificar as piores altera\\u00e7\\u00f5es de al\\u00edquota, que se afastaram da refer\\u00eancia e tiveram alto impacto.\\r\\nSELECT\\r\\n    '4.2. Ranking de Piora de Alto Impacto (ALERTA VERMELHO)' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    periodo,\\r\\n    gtin,\\r\\n    descricao,\\r\\n    aliquota_historica_pct,\\r\\n    aliquota_praticada_pct,\\r\\n    aliquota_correta_ia_pct,\\r\\n    bc_total_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    classificacao_mudanca = 'MUDANCA_EXTREMA'\\r\\n    AND movimento_vs_ia = 'AFASTOU_DA_CORRETA'\\r\\nORDER BY\\r\\n    bc_total_periodo DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- 4.3. An\\u00e1lise de Inconsist\\u00eancia Cr\\u00f4nica por Produto\\r\\n-- Objetivo: Encontrar produtos que, mesmo com comportamento est\\u00e1vel, possuem grande diverg\\u00eancia entre a al\\u00edquota praticada e a de refer\\u00eancia.\\r\\nSELECT\\r\\n    '4.3. An\\u00e1lise de Inconsist\\u00eancia Cr\\u00f4nica por Produto' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    gtin,\\r\\n    descricao,\\r\\n    -- Usamos AVG para agregar os valores ao longo dos per\\u00edodos para o mesmo produto\\r\\n    AVG(aliquota_historica_pct) as aliquota_media_praticada,\\r\\n    MAX(aliquota_correta_ia_pct) as aliquota_referencia,\\r\\n    ABS(AVG(aliquota_historica_pct) - MAX(aliquota_correta_ia_pct)) AS divergencia_percentual,\\r\\n    SUM(bc_total_periodo) as valor_total_no_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    aliquota_correta_ia_pct IS NOT NULL\\r\\n    AND classificacao_mudanca = 'COMPORTAMENTO_NORMAL'\\r\\nGROUP BY\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    gtin,\\r\\n    descricao\\r\\nHAVING\\r\\n    ABS(AVG(aliquota_historica_pct) - MAX(aliquota_correta_ia_pct)) > 5 -- Filtra para diverg\\u00eancias acima de 5 pontos percentuais.\\r\\nORDER BY\\r\\n    divergencia_percentual DESC,\\r\\n    valor_total_no_periodo DESC\\r\\nLIMIT 50;\", \"statementsList\": [\"/***************************************************************************************************\\r\\n * =================================================================================================\\r\\n * SCRIPT UNIFICADO DE AN\\u00c1LISE E CONSULTA - SISTEMA ARGOS (An\\u00e1lise de Comportamento Tribut\\u00e1rio)\\r\\n * =================================================================================================\\r\\n *\\r\\n * DESCRI\\u00c7\\u00c3O:\\r\\n * Este script cont\\u00e9m um conjunto completo de consultas prontas para uso que extraem estat\\u00edsticas,\\r\\n * rankings e an\\u00e1lises detalhadas do sistema Argos.\\r\\n *\\r\\n * COMO USAR:\\r\\n * 1. Para as \\\"An\\u00e1lises Completas (Dossi\\u00ea da Empresa)\\\", modifique o CNPJ na cl\\u00e1usula WHERE.\\r\\n * 2. Execute o script completo ou cada consulta individualmente.\\r\\n *\\r\\n * DATA DE GERA\\u00c7\\u00c3O: 01 de Outubro de 2025\\r\\n ***************************************************************************************************/\\r\\n\\r\\n-- =================================================================================================\\r\\n-- SE\\u00c7\\u00c3O 1: ESTAT\\u00cdSTICAS GERAIS DO SISTEMA (VIS\\u00c3O MACRO)\\r\\n-- =================================================================================================\\r\\n\\r\\n-- 1.1. Resumo Quantitativo do Ambiente Argos\\r\\n-- Objetivo: Obter as contagens totais de empresas, produtos, per\\u00edodos e eventos de mudan\\u00e7a monitorados.\\r\\nSELECT\\r\\n    '1.1. Resumo Quantitativo do Ambiente Argos' AS consulta,\\r\\n    COUNT(DISTINCT cnpj_emitente) AS total_empresas_analisadas,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm, '-', descricao)) AS total_produtos_unicos_com_mudanca,\\r\\n    COUNT(DISTINCT periodo) AS total_periodos_com_mudanca,\\r\\n    COUNT(*) AS total_eventos_de_mudanca_registrados -- (Cada linha na view \\u00e9 um evento empresa-produto-m\\u00eas)\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce;\", \"\\r\\n\\r\\n\\r\\n-- 1.2. Distribui\\u00e7\\u00e3o das Mudan\\u00e7as por Classifica\\u00e7\\u00e3o de Risco\\r\\n-- Objetivo: Entender o volume de cada tipo de mudan\\u00e7a de comportamento.\\r\\nSELECT\\r\\n    '1.2. Distribui\\u00e7\\u00e3o das Mudan\\u00e7as por Classifica\\u00e7\\u00e3o de Risco' AS consulta,\\r\\n    classificacao_mudanca,\\r\\n    COUNT(*) AS quantidade_de_eventos,\\r\\n    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM niat.argos_vw_evolucao_nfce), 2) AS percentual_total\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nGROUP BY\\r\\n    classificacao_mudanca\\r\\nORDER BY\\r\\n    quantidade_de_eventos DESC;\", \"\\r\\n\\r\\n\\r\\n-- 1.3. An\\u00e1lise de Qualidade do Movimento (Aproxima\\u00e7\\u00e3o vs. Afastamento da Al\\u00edquota Correta)\\r\\n-- Objetivo: Avaliar se as mudan\\u00e7as est\\u00e3o, em geral, corrigindo ou piorando a tributa\\u00e7\\u00e3o.\\r\\nSELECT\\r\\n    '1.3. An\\u00e1lise de Qualidade do Movimento vs. IA' AS consulta,\\r\\n    movimento_vs_ia,\\r\\n    COUNT(*) AS quantidade_de_eventos,\\r\\n    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM niat.argos_vw_evolucao_nfce WHERE movimento_vs_ia <> 'SEM_REFERENCIA_IA'), 2) AS percentual_dos_casos_com_referencia\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nGROUP BY\\r\\n    movimento_vs_ia\\r\\nORDER BY\\r\\n    quantidade_de_eventos DESC;\", \"\\r\\n\\r\\n\\r\\n-- =================================================================================================\\r\\n-- SE\\u00c7\\u00c3O 2: CONSULTAS ANAL\\u00cdTICAS (RANKINGS E PADR\\u00d5ES)\\r\\n-- =================================================================================================\\r\\n\\r\\n-- 2.1. Top 20 Empresas por Volume de Mudan\\u00e7as de Al\\u00edquota (Extremas + Significativas)\\r\\n-- Objetivo: Identificar as empresas com o comportamento tribut\\u00e1rio mais inst\\u00e1vel.\\r\\nSELECT\\r\\n    '2.1. Top 20 Empresas por Volume de Mudan\\u00e7as' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    COUNT(*) AS total_eventos_de_mudanca,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm, '-', descricao)) AS produtos_afetados,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS total_mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) AS total_mudancas_significativas,\\r\\n    SUM(bc_total_periodo) AS valor_total_envolvido_nas_mudancas\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nGROUP BY\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente\\r\\nORDER BY\\r\\n    total_eventos_de_mudanca DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n\\r\\n-- 2.2. Top 20 Empresas por Impacto Financeiro Potencial\\r\\n-- Objetivo: Listar as empresas cujas mudan\\u00e7as de al\\u00edquota envolveram o maior volume financeiro (base de c\\u00e1lculo).\\r\\nSELECT\\r\\n    '2.2. Top 20 Empresas por Impacto Financeiro Potencial' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    SUM(bc_total_periodo) AS valor_total_envolvido_nas_mudancas,\\r\\n    COUNT(*) AS total_eventos_de_mudanca,\\r\\n    -- Calcula a diferen\\u00e7a m\\u00e9dia de al\\u00edquota para dar contexto\\r\\n    AVG(aliquota_praticada_pct - aliquota_historica_pct) as variacao_media_percentual\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nGROUP BY\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente\\r\\nORDER BY\\r\\n    valor_total_envolvido_nas_mudancas DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n\\r\\n-- 2.3. Top 20 Produtos com Mudan\\u00e7as Mais Frequentes (em diferentes empresas)\\r\\n-- Objetivo: Identificar produtos que s\\u00e3o foco recorrente de altera\\u00e7\\u00f5es de al\\u00edquota, podendo indicar dificuldade de classifica\\u00e7\\u00e3o fiscal.\\r\\nSELECT\\r\\n    '2.3. Top 20 Produtos com Mudan\\u00e7as Mais Frequentes' AS consulta,\\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    COUNT(*) AS total_eventos_de_mudanca,\\r\\n    COUNT(DISTINCT cnpj_emitente) AS empresas_distintas_com_mudanca\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nGROUP BY\\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao\\r\\nORDER BY\\r\\n    total_eventos_de_mudanca DESC,\\r\\n    empresas_distintas_com_mudanca DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n\\r\\n-- 2.4. An\\u00e1lise de Tend\\u00eancia Mensal das Mudan\\u00e7as de Comportamento (VERS\\u00c3O CORRIGIDA)\\r\\n-- Objetivo: Observar a evolu\\u00e7\\u00e3o da quantidade e qualidade das mudan\\u00e7as ao longo do tempo.\\r\\nSELECT\\r\\n    '2.4. An\\u00e1lise de Tend\\u00eancia Mensal' AS consulta,\\r\\n    periodo,\\r\\n    COUNT(*) AS total_eventos_de_mudanca,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) as mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) as mudancas_significativas,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS movimentos_de_correcao,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS movimentos_de_piora,\\r\\n    SUM(bc_total_periodo) as valor_total_envolvido_no_mes\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    -- CORRE\\u00c7\\u00c3O APLICADA AQUI \\ud83d\\udc47: Trocado DATE_ADD por ADD_MONTHS\\r\\n    periodo >= DATE_FORMAT(ADD_MONTHS(CURRENT_DATE(), -12), 'yyyyMM') -- Analisa os \\u00faltimos 12 meses.\\r\\nGROUP BY\\r\\n    periodo\\r\\nORDER BY\\r\\n    periodo DESC;\", \"\\r\\n\\r\\n\\r\\n-- =================================================================================================\\r\\n-- SE\\u00c7\\u00c3O 3: AN\\u00c1LISES COMPLETAS (DOSSI\\u00ca DA EMPRESA)\\r\\n-- Instru\\u00e7\\u00e3o: Substitua '00000000000000' pelo CNPJ que deseja investigar.\\r\\n-- =================================================================================================\\r\\n\\r\\n-- 3.1. Dossi\\u00ea da Empresa: Vis\\u00e3o Geral e M\\u00e9tricas Chave\\r\\nSELECT\\r\\n    '3.1. Dossi\\u00ea da Empresa - M\\u00e9tricas Consolidadas' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    COUNT(*) AS total_eventos_de_mudanca,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm, '-', descricao)) AS produtos_distintos_afetados,\\r\\n    SUM(bc_total_periodo) AS valor_total_envolvido,\\r\\n    MIN(periodo) AS primeiro_mes_com_mudanca,\\r\\n    MAX(periodo) AS ultimo_mes_com_mudanca,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS total_mudancas_extremas,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS total_movimentos_de_correcao,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS total_movimentos_de_piora\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    cnpj_emitente = '00000000000000' -- << MODIFIQUE AQUI O CNPJ ALVO\\r\\nGROUP BY\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente;\", \"\\r\\n\\r\\n\\r\\n-- 3.2. Dossi\\u00ea da Empresa: Detalhe das Mudan\\u00e7as por Produto\\r\\n-- Lista todos os produtos de uma empresa que sofreram altera\\u00e7\\u00f5es, ordenados pelo maior impacto (valor).\\r\\nSELECT\\r\\n    '3.2. Dossi\\u00ea da Empresa - Detalhe das Mudan\\u00e7as por Produto' AS consulta,\\r\\n    periodo,\\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    aliquota_historica_pct,\\r\\n    aliquota_praticada_pct,\\r\\n    aliquota_correta_ia_pct,\\r\\n    classificacao_mudanca,\\r\\n    movimento_vs_ia,\\r\\n    bc_total_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    cnpj_emitente = '00000000000000' -- << MODIFIQUE AQUI O CNPJ ALVO\\r\\nORDER BY\\r\\n    bc_total_periodo DESC,\\r\\n    periodo DESC;\", \"\\r\\n\\r\\n\\r\\n-- =================================================================================================\\r\\n-- SE\\u00c7\\u00c3O 4: AN\\u00c1LISES DE RISCO E CEN\\u00c1RIOS ESPEC\\u00cdFICOS\\r\\n-- =================================================================================================\\r\\n\\r\\n-- 4.1. Ranking de \\\"Corre\\u00e7\\u00e3o de Alto Impacto\\\"\\r\\n-- Objetivo: Identificar as corre\\u00e7\\u00f5es de al\\u00edquota mais relevantes financeiramente.\\r\\nSELECT\\r\\n    '4.1. Ranking de Corre\\u00e7\\u00e3o de Alto Impacto' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    periodo,\\r\\n    gtin,\\r\\n    descricao,\\r\\n    aliquota_historica_pct,\\r\\n    aliquota_praticada_pct,\\r\\n    aliquota_correta_ia_pct,\\r\\n    bc_total_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    classificacao_mudanca = 'MUDANCA_EXTREMA'\\r\\n    AND movimento_vs_ia = 'APROXIMOU_DA_CORRETA'\\r\\nORDER BY\\r\\n    bc_total_periodo DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n\\r\\n-- 4.2. Ranking de \\\"Piora de Alto Impacto\\\" (ALERTA VERMELHO)\\r\\n-- Objetivo: Identificar as piores altera\\u00e7\\u00f5es de al\\u00edquota, que se afastaram da refer\\u00eancia e tiveram alto impacto.\\r\\nSELECT\\r\\n    '4.2. Ranking de Piora de Alto Impacto (ALERTA VERMELHO)' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    periodo,\\r\\n    gtin,\\r\\n    descricao,\\r\\n    aliquota_historica_pct,\\r\\n    aliquota_praticada_pct,\\r\\n    aliquota_correta_ia_pct,\\r\\n    bc_total_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    classificacao_mudanca = 'MUDANCA_EXTREMA'\\r\\n    AND movimento_vs_ia = 'AFASTOU_DA_CORRETA'\\r\\nORDER BY\\r\\n    bc_total_periodo DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n\\r\\n-- 4.3. An\\u00e1lise de Inconsist\\u00eancia Cr\\u00f4nica por Produto\\r\\n-- Objetivo: Encontrar produtos que, mesmo com comportamento est\\u00e1vel, possuem grande diverg\\u00eancia entre a al\\u00edquota praticada e a de refer\\u00eancia.\\r\\nSELECT\\r\\n    '4.3. An\\u00e1lise de Inconsist\\u00eancia Cr\\u00f4nica por Produto' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    gtin,\\r\\n    descricao,\\r\\n    -- Usamos AVG para agregar os valores ao longo dos per\\u00edodos para o mesmo produto\\r\\n    AVG(aliquota_historica_pct) as aliquota_media_praticada,\\r\\n    MAX(aliquota_correta_ia_pct) as aliquota_referencia,\\r\\n    ABS(AVG(aliquota_historica_pct) - MAX(aliquota_correta_ia_pct)) AS divergencia_percentual,\\r\\n    SUM(bc_total_periodo) as valor_total_no_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    aliquota_correta_ia_pct IS NOT NULL\\r\\n    AND classificacao_mudanca = 'COMPORTAMENTO_NORMAL'\\r\\nGROUP BY\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    gtin,\\r\\n    descricao\\r\\nHAVING\\r\\n    ABS(AVG(aliquota_historica_pct) - MAX(aliquota_correta_ia_pct)) > 5 -- Filtra para diverg\\u00eancias acima de 5 pontos percentuais.\\r\\nORDER BY\\r\\n    divergencia_percentual DESC,\\r\\n    valor_total_no_periodo DESC\\r\\nLIMIT 50;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\n\\r\\n\\r\\n-- =================================================================================================\\r\\n-- SE\\u00c7\\u00c3O 4: AN\\u00c1LISES DE RISCO E CEN\\u00c1RIOS ESPEC\\u00cdFICOS\\r\\n-- =================================================================================================\\r\\n\\r\\n-- 4.1. Ranking de \\\"Corre\\u00e7\\u00e3o de Alto Impacto\\\"\\r\\n-- Objetivo: Identificar as corre\\u00e7\\u00f5es de al\\u00edquota mais relevantes financeiramente.\\r\\nSELECT\\r\\n    '4.1. Ranking de Corre\\u00e7\\u00e3o de Alto Impacto' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    periodo,\\r\\n    gtin,\\r\\n    descricao,\\r\\n    aliquota_historica_pct,\\r\\n    aliquota_praticada_pct,\\r\\n    aliquota_correta_ia_pct,\\r\\n    bc_total_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    classificacao_mudanca = 'MUDANCA_EXTREMA'\\r\\n    AND movimento_vs_ia = 'APROXIMOU_DA_CORRETA'\\r\\nORDER BY\\r\\n    bc_total_periodo DESC\\r\\nLIMIT 20;\", \"result\": {\"id\": \"1d1bb3ab-8289-a1cb-58d3-b4e55de9113a\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"6DFJqfebTI+6Kk6qHPTb0g==\", \"guid\": \"zJ9KG+e5Q8kAAAAAuvWNXA==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"e048a602c75d2ef3:b097a608997311a7\", \"session_id\": 21048, \"session_type\": \"impala\", \"statement_id\": 4, \"has_more_statements\": false, \"statements_count\": 5, \"previous_statement_hash\": \"a53f35000dd99fdb972fdf9ed27a80acea17c600fa3099a7c1e49ce1\", \"start\": {\"row\": 100, \"column\": 0}, \"end\": {\"row\": 128, \"column\": 8}, \"statement\": \"-- 4.3. An\\u00e1lise de Inconsist\\u00eancia Cr\\u00f4nica por Produto\\n-- Objetivo: Encontrar produtos que, mesmo com comportamento est\\u00e1vel, possuem grande diverg\\u00eancia entre a al\\u00edquota praticada e a de refer\\u00eancia.\\nSELECT\\n    '4.3. An\\u00e1lise de Inconsist\\u00eancia Cr\\u00f4nica por Produto' AS consulta,\\n    nm_razao_social,\\n    cnpj_emitente,\\n    gtin,\\n    descricao,\\n    -- Usamos AVG para agregar os valores ao longo dos per\\u00edodos para o mesmo produto\\n    AVG(aliquota_historica_pct) as aliquota_media_praticada,\\n    MAX(aliquota_correta_ia_pct) as aliquota_referencia,\\n    ABS(AVG(aliquota_historica_pct) - MAX(aliquota_correta_ia_pct)) AS divergencia_percentual,\\n    SUM(bc_total_periodo) as valor_total_no_periodo\\nFROM\\n    niat.argos_vw_evolucao_nfce\\nWHERE\\n    aliquota_correta_ia_pct IS NOT NULL\\n    AND classificacao_mudanca = 'COMPORTAMENTO_NORMAL'\\nGROUP BY\\n    nm_razao_social,\\n    cnpj_emitente,\\n    gtin,\\n    descricao\\nHAVING\\n    ABS(AVG(aliquota_historica_pct) - MAX(aliquota_correta_ia_pct)) > 5 -- Filtra para diverg\\u00eancias acima de 5 pontos percentuais.\\nORDER BY\\n    divergencia_percentual DESC,\\n    valor_total_no_periodo DESC\\nLIMIT 50\"}, \"meta\": [], \"rows\": 50, \"hasMore\": false, \"statement_id\": 4, \"statement_range\": {\"start\": {\"row\": 100, \"column\": 0}, \"end\": {\"row\": 128, \"column\": 8}}, \"statements_count\": 5, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 9, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"consulta\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}, {\"name\": \"nm_razao_social\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 2}, {\"name\": \"cnpj_emitente\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 3}, {\"name\": \"gtin\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 4}, {\"name\": \"descricao\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 5}, {\"name\": \"aliquota_media_praticada\", \"type\": \"decimal\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 6}, {\"name\": \"aliquota_referencia\", \"type\": \"double\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 7}, {\"name\": \"divergencia_percentual\", \"type\": \"decimal\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 8}, {\"name\": \"valor_total_no_periodo\", \"type\": \"decimal\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 9}], \"fetchedOnce\": false, \"startTime\": \"2025-10-01T14:15:41.737Z\", \"endTime\": \"2025-10-01T14:15:43.059Z\", \"executionTime\": 1322, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 9, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"consulta\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"aliquota_referencia\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"consulta\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"aliquota_praticada_pct\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 2930, \"getLogsTimeout\": 2964, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1759328141458, \"lastAceSelectionRowOffset\": 150, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- =================================================================================================\\r\\n-- SE\\u00c7\\u00c3O 3: AN\\u00c1LISES COMPLETAS (DOSSI\\u00ca DA EMPRESA)\\r\\n-- Instru\\u00e7\\u00e3o: Substitua '00000000000000' pelo CNPJ que deseja investigar.\\r\\n-- =================================================================================================\\r\\n\\r\\n-- 3.1. Dossi\\u00ea da Empresa: Vis\\u00e3o Geral e M\\u00e9tricas Chave\\r\\nSELECT\\r\\n    '3.1. Dossi\\u00ea da Empresa - M\\u00e9tricas Consolidadas' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    COUNT(*) AS total_eventos_de_mudanca,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm, '-', descricao)) AS produtos_distintos_afetados,\\r\\n    SUM(bc_total_periodo) AS valor_total_envolvido,\\r\\n    MIN(periodo) AS primeiro_mes_com_mudanca,\\r\\n    MAX(periodo) AS ultimo_mes_com_mudanca,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS total_mudancas_extremas,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS total_movimentos_de_correcao,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS total_movimentos_de_piora\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    cnpj_emitente = '00000000000000' -- << MODIFIQUE AQUI O CNPJ ALVO\\r\\nGROUP BY\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente;\\r\\n\\r\\n\\r\\n-- 3.2. Dossi\\u00ea da Empresa: Detalhe das Mudan\\u00e7as por Produto\\r\\n-- Lista todos os produtos de uma empresa que sofreram altera\\u00e7\\u00f5es, ordenados pelo maior impacto (valor).\\r\\nSELECT\\r\\n    '3.2. Dossi\\u00ea da Empresa - Detalhe das Mudan\\u00e7as por Produto' AS consulta,\\r\\n    periodo,\\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    aliquota_historica_pct,\\r\\n    aliquota_praticada_pct,\\r\\n    aliquota_correta_ia_pct,\\r\\n    classificacao_mudanca,\\r\\n    movimento_vs_ia,\\r\\n    bc_total_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    cnpj_emitente = '00000000000000' -- << MODIFIQUE AQUI O CNPJ ALVO\\r\\nORDER BY\\r\\n    bc_total_periodo DESC,\\r\\n    periodo DESC;\\r\\n\\r\\n\\r\\n-- =================================================================================================\\r\\n-- SE\\u00c7\\u00c3O 4: AN\\u00c1LISES DE RISCO E CEN\\u00c1RIOS ESPEC\\u00cdFICOS\\r\\n-- =================================================================================================\\r\\n\\r\\n-- 4.1. Ranking de \\\"Corre\\u00e7\\u00e3o de Alto Impacto\\\"\\r\\n-- Objetivo: Identificar as corre\\u00e7\\u00f5es de al\\u00edquota mais relevantes financeiramente.\\r\\nSELECT\\r\\n    '4.1. Ranking de Corre\\u00e7\\u00e3o de Alto Impacto' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    periodo,\\r\\n    gtin,\\r\\n    descricao,\\r\\n    aliquota_historica_pct,\\r\\n    aliquota_praticada_pct,\\r\\n    aliquota_correta_ia_pct,\\r\\n    bc_total_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    classificacao_mudanca = 'MUDANCA_EXTREMA'\\r\\n    AND movimento_vs_ia = 'APROXIMOU_DA_CORRETA'\\r\\nORDER BY\\r\\n    bc_total_periodo DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- 4.2. Ranking de \\\"Piora de Alto Impacto\\\" (ALERTA VERMELHO)\\r\\n-- Objetivo: Identificar as piores altera\\u00e7\\u00f5es de al\\u00edquota, que se afastaram da refer\\u00eancia e tiveram alto impacto.\\r\\nSELECT\\r\\n    '4.2. Ranking de Piora de Alto Impacto (ALERTA VERMELHO)' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    periodo,\\r\\n    gtin,\\r\\n    descricao,\\r\\n    aliquota_historica_pct,\\r\\n    aliquota_praticada_pct,\\r\\n    aliquota_correta_ia_pct,\\r\\n    bc_total_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    classificacao_mudanca = 'MUDANCA_EXTREMA'\\r\\n    AND movimento_vs_ia = 'AFASTOU_DA_CORRETA'\\r\\nORDER BY\\r\\n    bc_total_periodo DESC\\r\\nLIMIT 20;\\r\\n\\r\\n\\r\\n-- 4.3. An\\u00e1lise de Inconsist\\u00eancia Cr\\u00f4nica por Produto\\r\\n-- Objetivo: Encontrar produtos que, mesmo com comportamento est\\u00e1vel, possuem grande diverg\\u00eancia entre a al\\u00edquota praticada e a de refer\\u00eancia.\\r\\nSELECT\\r\\n    '4.3. An\\u00e1lise de Inconsist\\u00eancia Cr\\u00f4nica por Produto' AS consulta,\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    gtin,\\r\\n    descricao,\\r\\n    -- Usamos AVG para agregar os valores ao longo dos per\\u00edodos para o mesmo produto\\r\\n    AVG(aliquota_historica_pct) as aliquota_media_praticada,\\r\\n    MAX(aliquota_correta_ia_pct) as aliquota_referencia,\\r\\n    ABS(AVG(aliquota_historica_pct) - MAX(aliquota_correta_ia_pct)) AS divergencia_percentual,\\r\\n    SUM(bc_total_periodo) as valor_total_no_periodo\\r\\nFROM\\r\\n    niat.argos_vw_evolucao_nfce\\r\\nWHERE\\r\\n    aliquota_correta_ia_pct IS NOT NULL\\r\\n    AND classificacao_mudanca = 'COMPORTAMENTO_NORMAL'\\r\\nGROUP BY\\r\\n    nm_razao_social,\\r\\n    cnpj_emitente,\\r\\n    gtin,\\r\\n    descricao\\r\\nHAVING\\r\\n    ABS(AVG(aliquota_historica_pct) - MAX(aliquota_correta_ia_pct)) > 5 -- Filtra para diverg\\u00eancias acima de 5 pontos percentuais.\\r\\nORDER BY\\r\\n    divergencia_percentual DESC,\\r\\n    valor_total_no_periodo DESC\\r\\nLIMIT 50;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 150, \"column\": 0}, \"end\": {\"row\": 278, \"column\": 9}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query c943b9e71b4a9fcc:5c8df5ba00000000 100% Complete (8 out of 8)\\\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY cnpj_emitente ASC, descricao ASC, periodo ASC.\\\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"c943b9e71b4a9fcc:5c8df5ba00000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=c943b9e71b4a9fcc:5c8df5ba00000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query c943b9e71b4a9fcc:5c8df5ba00000000 100% Complete (8 out of 8)\\nIgnoring ORDER BY clause without LIMIT or OFFSET: ORDER BY cnpj_emitente ASC, descricao ASC, periodo ASC.\\nAn ORDER BY appearing in a view, subquery, union operand, or an insert/ctas statement has no effect on the query result unless a LIMIT and/or OFFSET is used in conjunction with the ORDER BY.\", \"progress\": 100, \"jobs\": [{\"name\": \"c943b9e71b4a9fcc:5c8df5ba00000000\", \"url\": \"/hue/jobbrowser#!id=c943b9e71b4a9fcc:5c8df5ba00000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 10118, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 98, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": null, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "/***************************************************************************************************\r\n * =================================================================================================\r\n * SCRIPT UNIFICADO DE ANÁLISE E CONSULTA - SISTEMA ARGOS (Análise de Comportamento Tributário)\r\n * =================================================================================================\r\n *\r\n * DESCRIÇÃO:\r\n * Este script contém um conjunto completo de consultas prontas para uso que extraem estatísticas,\r\n * rankings e análises detalhadas do sistema Argos.\r\n *\r\n * COMO USAR:\r\n * 1. Para as \"Análises Completas (Dossiê da Empresa)\", modifique o CNPJ na cláusula WHERE.\r\n * 2. Execute o script completo ou cada consulta individualmente.\r\n *\r\n * DATA DE GERAÇÃO: 01 de Outubro de 2025\r\n ***************************************************************************************************/\r\n\r\n-- =================================================================================================\r\n-- SEÇÃO 1: ESTATÍSTICAS GERAIS DO SISTEMA (VISÃO MACRO)\r\n-- =================================================================================================\r\n\r\n-- 1.1. Resumo Quantitativo do Ambiente Argos\r\n-- Objetivo: Obter as contagens totais de empresas, produtos, períodos e eventos de mudança monitorados.\r\nSELECT\r\n    '1.1. Resumo Quantitativo do Ambiente Argos' AS consulta,\r\n    COUNT(DISTINCT cnpj_emitente) AS total_empresas_analisadas,\r\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm, '-', descricao)) AS total_produtos_unicos_com_mudanca,\r\n    COUNT(DISTINCT periodo) AS total_periodos_com_mudanca,\r\n    COUNT(*) AS total_eventos_de_mudanca_registrados -- (Cada linha na view é um evento empresa-produto-mês)\r\nFROM\r\n    niat.argos_vw_evolucao_nfce;\r\n\r\n\r\n-- 1.2. Distribuição das Mudanças por Classificação de Risco\r\n-- Objetivo: Entender o volume de cada tipo de mudança de comportamento.\r\nSELECT\r\n    '1.2. Distribuição das Mudanças por Classificação de Risco' AS consulta,\r\n    cla",
    "last_modified": "2025-10-01T11:16:06.954",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "9c31952e-c6b2-404c-9369-a01b5cd73495",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 158471,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "ARGOS: ANALISES C",
    "description": "",
    "uuid": "10b2e29a-fc37-f433-a956-c0a3f661d943",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 158471, \"uuid\": \"10b2e29a-fc37-f433-a956-c0a3f661d943\", \"name\": \"ARGOS: ANALISES C\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"56af4529-8a68-dacb-5378-c5f6e163a1c1\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": null, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"default\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- SISTEMA ARGOS - CONSULTAS ANAL\\u00cdTICAS COMPLETAS\\r\\n-- An\\u00e1lise de Mudan\\u00e7a de Comportamento Tribut\\u00e1rio\\r\\n-- Receita Estadual de Santa Catarina\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\\r\\nSET MEM_LIMIT = 8G;\\r\\n\\r\\n-- ============================================================================\\r\\n-- 1. ESTAT\\u00cdSTICAS GERAIS DO SISTEMA ARGOS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 1.1 PANORAMA GERAL DO SISTEMA\\r\\nSELECT \\r\\n    'PANORAMA GERAL DO SISTEMA ARGOS' AS categoria,\\r\\n    \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT cnpj_emitente) AS total_empresas_monitoradas,\\r\\n    COUNT(DISTINCT periodo) AS total_periodos_analisados,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS total_produtos_distintos,\\r\\n    COUNT(*) AS total_registros_base,\\r\\n    \\r\\n    -- M\\u00e9tricas de Cobertura de Dados\\r\\n    COUNT(DISTINCT CASE WHEN aliquota_ia IS NOT NULL THEN CONCAT(gtin, '-', ncm) END) AS produtos_com_aliquota_ia,\\r\\n    ROUND(COUNT(DISTINCT CASE WHEN aliquota_ia IS NOT NULL THEN CONCAT(gtin, '-', ncm) END) * 100.0 / \\r\\n          COUNT(DISTINCT CONCAT(gtin, '-', ncm)), 2) AS perc_cobertura_ia,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    SUM(bc_total_periodo) AS base_calculo_total_sistema,\\r\\n    ROUND(AVG(bc_total_periodo), 2) AS bc_media_por_registro,\\r\\n    \\r\\n    -- M\\u00e9tricas de Qualidade\\r\\n    COUNT(CASE WHEN gtin = 'SEM GTIN' THEN 1 END) AS registros_sem_gtin,\\r\\n    ROUND(COUNT(CASE WHEN gtin = 'SEM GTIN' THEN 1 END) * 100.0 / COUNT(*), 2) AS perc_sem_gtin,\\r\\n    \\r\\n    -- Data de Atualiza\\u00e7\\u00e3o\\r\\n    MAX(periodo) AS ultimo_periodo_processado,\\r\\n    MIN(periodo) AS primeiro_periodo_processado,\\r\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_consulta\\r\\n    \\r\\nFROM niat.argos_nfce_periodo_base;\\r\\n\\r\\n-- 1.2 DISTRIBUI\\u00c7\\u00c3O DE MUDAN\\u00c7AS POR CLASSIFICA\\u00c7\\u00c3O\\r\\nSELECT \\r\\n    'DISTRIBUI\\u00c7\\u00c3O DE MUDAN\\u00c7AS POR CLASSIFICA\\u00c7\\u00c3O' AS categoria,\\r\\n    \\r\\n    classificacao_mudanca,\\r\\n    COUNT(*) AS quantidade_casos,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual,\\r\\n    COUNT(DISTINCT cnpj_emitente) AS empresas_afetadas,\\r\\n    SUM(bc_total_periodo) AS base_calculo_total,\\r\\n    ROUND(AVG(bc_total_periodo), 2) AS bc_media,\\r\\n    \\r\\n    -- M\\u00e9tricas de Movimento vs IA\\r\\n    COUNT(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 END) AS casos_aproximou_ia,\\r\\n    COUNT(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 END) AS casos_afastou_ia,\\r\\n    COUNT(CASE WHEN movimento_vs_ia = 'MANTEVE_DISTANCIA' THEN 1 END) AS casos_manteve_distancia,\\r\\n    \\r\\n    -- Percentuais de Movimento\\r\\n    ROUND(COUNT(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS perc_aproximou\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE classificacao_mudanca IS NOT NULL\\r\\nGROUP BY classificacao_mudanca\\r\\nORDER BY quantidade_casos DESC;\\r\\n\\r\\n-- 1.3 EVOLU\\u00c7\\u00c3O TEMPORAL DAS MUDAN\\u00c7AS\\r\\nSELECT \\r\\n    'EVOLU\\u00c7\\u00c3O TEMPORAL DAS MUDAN\\u00c7AS' AS categoria,\\r\\n    \\r\\n    periodo,\\r\\n    COUNT(*) AS total_casos_periodo,\\r\\n    COUNT(DISTINCT cnpj_emitente) AS empresas_ativas_periodo,\\r\\n    SUM(bc_total_periodo) AS base_calculo_periodo,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Classifica\\u00e7\\u00e3o\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) AS mudancas_significativas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'COMPORTAMENTO_NORMAL' THEN 1 ELSE 0 END) AS comportamento_normal,\\r\\n    \\r\\n    -- Movimento vs Al\\u00edquota Correta\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS aproximou_da_correta,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS afastou_da_correta,\\r\\n    \\r\\n    -- Taxa de Corre\\u00e7\\u00e3o do Per\\u00edodo\\r\\n    ROUND(SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_correcao_periodo\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nGROUP BY periodo\\r\\nORDER BY periodo DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- 2. CONSULTAS ANAL\\u00cdTICAS ESPEC\\u00cdFICAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 2.1 RANKING DE EMPRESAS POR MUDAN\\u00c7AS EXTREMAS\\r\\nSELECT \\r\\n    'TOP 20 EMPRESAS - MUDAN\\u00c7AS EXTREMAS' AS categoria,\\r\\n    \\r\\n    mc.cnpj_emitente,\\r\\n    mc.nm_razao_social,\\r\\n    COUNT(*) AS total_mudancas_extremas,\\r\\n    COUNT(DISTINCT periodo) AS periodos_com_mudancas,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS produtos_afetados,\\r\\n    SUM(bc_total_periodo) AS base_calculo_total,\\r\\n    \\r\\n    -- Dire\\u00e7\\u00e3o das Mudan\\u00e7as\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS casos_aproximou,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS casos_afastou,\\r\\n    \\r\\n    -- Taxa de Corre\\u00e7\\u00e3o\\r\\n    ROUND(SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) * 100.0 / \\r\\n          COUNT(*), 2) AS taxa_correcao_empresa,\\r\\n    \\r\\n    -- Per\\u00edodo mais recente\\r\\n    MAX(periodo) AS ultimo_periodo_ativo\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento mc\\r\\nWHERE classificacao_mudanca = 'MUDANCA_EXTREMA'\\r\\nGROUP BY mc.cnpj_emitente, mc.nm_razao_social\\r\\nORDER BY total_mudancas_extremas DESC, base_calculo_total DESC\\r\\nLIMIT 20;\\r\\n\\r\\n-- 2.2 AN\\u00c1LISE DE PRODUTOS COM MAIOR VOLATILIDADE\\r\\nSELECT \\r\\n    'TOP 30 PRODUTOS - MAIOR VOLATILIDADE' AS categoria,\\r\\n    \\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    aliquota_ia,\\r\\n    \\r\\n    COUNT(DISTINCT cnpj_emitente) AS qtd_empresas_praticantes,\\r\\n    COUNT(DISTINCT periodo) AS qtd_periodos_observados,\\r\\n    \\r\\n    -- Estat\\u00edsticas de Al\\u00edquota\\r\\n    ROUND(AVG(aliq_emitente_periodo) * 100, 2) AS aliquota_media_pct,\\r\\n    ROUND(STDDEV(aliq_emitente_periodo) * 100, 2) AS desvio_padrao_pct,\\r\\n    ROUND(MIN(aliq_emitente_periodo) * 100, 2) AS aliquota_minima_pct,\\r\\n    ROUND(MAX(aliq_emitente_periodo) * 100, 2) AS aliquota_maxima_pct,\\r\\n    \\r\\n    -- Diferen\\u00e7a vs IA\\r\\n    ROUND(AVG(diferenca_vs_ia_periodo) * 100, 2) AS diferenca_media_vs_ia_pct,\\r\\n    \\r\\n    -- Volume Financeiro\\r\\n    SUM(bc_total_periodo) AS base_calculo_acumulada,\\r\\n    \\r\\n    -- Casos de Mudan\\u00e7a\\r\\n    SUM(CASE WHEN classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA') THEN 1 ELSE 0 END) AS casos_mudanca_relevante\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE aliquota_ia IS NOT NULL\\r\\nGROUP BY gtin, ncm, descricao, aliquota_ia\\r\\nHAVING COUNT(DISTINCT cnpj_emitente) >= 3  -- Produtos praticados por pelo menos 3 empresas\\r\\nORDER BY STDDEV(aliq_emitente_periodo) DESC, base_calculo_acumulada DESC\\r\\nLIMIT 30;\\r\\n\\r\\n-- 2.3 EFETIVIDADE DA FISCALIZA\\u00c7\\u00c3O (Empresas que Corrigiram)\\r\\nWITH empresas_fiscalizadas AS (\\r\\n    SELECT DISTINCT cnpj \\r\\n    FROM niat.argos_cnpj\\r\\n),\\r\\nanalise_correcao AS (\\r\\n    SELECT \\r\\n        mc.cnpj_emitente,\\r\\n        mc.nm_razao_social,\\r\\n        COUNT(*) AS total_produtos_analisados,\\r\\n        SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS produtos_corrigidos,\\r\\n        SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS produtos_piorados,\\r\\n        SUM(CASE WHEN classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA') THEN 1 ELSE 0 END) AS mudancas_relevantes,\\r\\n        SUM(bc_total_periodo) AS base_calculo_total,\\r\\n        AVG(ABS(diferenca_vs_ia_periodo)) AS diferenca_media_vs_ia\\r\\n    FROM niat.argos_mudanca_comportamento mc\\r\\n    INNER JOIN empresas_fiscalizadas ef ON mc.cnpj_emitente = ef.cnpj\\r\\n    WHERE aliquota_ia IS NOT NULL\\r\\n    GROUP BY mc.cnpj_emitente, mc.nm_razao_social\\r\\n)\\r\\nSELECT \\r\\n    'EFETIVIDADE DA FISCALIZA\\u00c7\\u00c3O' AS categoria,\\r\\n    \\r\\n    cnpj_emitente,\\r\\n    nm_razao_social,\\r\\n    total_produtos_analisados,\\r\\n    produtos_corrigidos,\\r\\n    produtos_piorados,\\r\\n    mudancas_relevantes,\\r\\n    \\r\\n    -- Taxa de Corre\\u00e7\\u00e3o\\r\\n    ROUND(produtos_corrigidos * 100.0 / NULLIF(total_produtos_analisados, 0), 2) AS taxa_correcao_pct,\\r\\n    \\r\\n    -- Padr\\u00e3o Comportamental\\r\\n    CASE \\r\\n        WHEN produtos_corrigidos >= (total_produtos_analisados * 0.6) THEN 'CORRIGINDO_ALIQUOTAS'\\r\\n        WHEN produtos_piorados >= (total_produtos_analisados * 0.6) THEN 'PIORANDO_ALIQUOTAS'\\r\\n        WHEN mudancas_relevantes >= (total_produtos_analisados * 0.4) THEN 'ALTA_VARIABILIDADE'\\r\\n        ELSE 'COMPORTAMENTO_ESTAVEL'\\r\\n    END AS padrao_comportamental,\\r\\n    \\r\\n    base_calculo_total,\\r\\n    ROUND(diferenca_media_vs_ia * 100, 2) AS diferenca_media_vs_ia_pct\\r\\n    \\r\\nFROM analise_correcao\\r\\nORDER BY taxa_correcao_pct DESC, base_calculo_total DESC;\\r\\n\\r\\n-- 2.4 AN\\u00c1LISE SETORIAL POR NCM (2 D\\u00cdGITOS)\\r\\nWITH ncm_secao AS (\\r\\n    SELECT \\r\\n        SUBSTR(CAST(ncm AS STRING), 1, 2) AS secao_ncm,\\r\\n        cnpj_emitente,\\r\\n        periodo,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        aliquota_ia,\\r\\n        aliq_emitente_periodo,\\r\\n        bc_total_periodo,\\r\\n        classificacao_mudanca,\\r\\n        movimento_vs_ia\\r\\n    FROM niat.argos_mudanca_comportamento\\r\\n    WHERE ncm IS NOT NULL\\r\\n)\\r\\nSELECT \\r\\n    'AN\\u00c1LISE SETORIAL POR NCM' AS categoria,\\r\\n    \\r\\n    secao_ncm,\\r\\n    CASE secao_ncm\\r\\n        WHEN '01' THEN 'Animais Vivos'\\r\\n        WHEN '02' THEN 'Carnes'\\r\\n        WHEN '04' THEN 'Leite e Latic\\u00ednios'\\r\\n        WHEN '17' THEN 'A\\u00e7\\u00facares'\\r\\n        WHEN '19' THEN 'Produtos de Cereais'\\r\\n        WHEN '22' THEN 'Bebidas'\\r\\n        WHEN '33' THEN '\\u00d3leos Essenciais e Cosm\\u00e9ticos'\\r\\n        WHEN '84' THEN 'M\\u00e1quinas e Equipamentos'\\r\\n        ELSE CONCAT('Se\\u00e7\\u00e3o ', secao_ncm)\\r\\n    END AS descricao_secao,\\r\\n    \\r\\n    COUNT(DISTINCT cnpj_emitente) AS empresas_no_setor,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS produtos_distintos,\\r\\n    COUNT(*) AS total_registros,\\r\\n    \\r\\n    -- Estat\\u00edsticas de Al\\u00edquota\\r\\n    ROUND(AVG(aliq_emitente_periodo) * 100, 2) AS aliquota_media_setor_pct,\\r\\n    ROUND(STDDEV(aliq_emitente_periodo) * 100, 2) AS desvio_aliquota_pct,\\r\\n    \\r\\n    -- Taxa de Corre\\u00e7\\u00e3o Setorial\\r\\n    ROUND(SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_correcao_setor_pct,\\r\\n    \\r\\n    -- Mudan\\u00e7as Significativas\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) AS mudancas_significativas,\\r\\n    \\r\\n    -- Volume Financeiro\\r\\n    SUM(bc_total_periodo) AS base_calculo_setor\\r\\n    \\r\\nFROM ncm_secao\\r\\nWHERE aliquota_ia IS NOT NULL\\r\\nGROUP BY secao_ncm\\r\\nHAVING COUNT(DISTINCT cnpj_emitente) >= 3  -- Setores com pelo menos 3 empresas\\r\\nORDER BY base_calculo_setor DESC;\\r\\n\\r\\n-- ============================================================================\\r\\n-- 3. AN\\u00c1LISES COMPLETAS (DOSSI\\u00ca DE EMPRESAS ESPEC\\u00cdFICAS)\\r\\n-- ============================================================================\\r\\n\\r\\n-- 3.1 DOSSI\\u00ca COMPLETO DE UMA EMPRESA\\r\\n-- Substitua '00000000000191' pelo CNPJ desejado\\r\\nSELECT \\r\\n    'DOSSI\\u00ca COMPLETO DA EMPRESA' AS categoria,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    cnpj_emitente,\\r\\n    nm_razao_social,\\r\\n    \\r\\n    -- Estat\\u00edsticas Gerais\\r\\n    COUNT(DISTINCT periodo) AS periodos_analisados,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS produtos_distintos,\\r\\n    COUNT(*) AS total_registros,\\r\\n    \\r\\n    -- M\\u00e9tricas de Mudan\\u00e7a\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) AS mudancas_significativas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'COMPORTAMENTO_NORMAL' THEN 1 ELSE 0 END) AS comportamento_normal,\\r\\n    \\r\\n    -- Movimento vs IA\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS casos_aproximou_ia,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS casos_afastou_ia,\\r\\n    \\r\\n    -- Taxa de Corre\\u00e7\\u00e3o\\r\\n    ROUND(SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_correcao_empresa_pct,\\r\\n    \\r\\n    -- Volume Financeiro\\r\\n    SUM(bc_total_periodo) AS base_calculo_total,\\r\\n    ROUND(AVG(bc_total_periodo), 2) AS bc_media_por_registro,\\r\\n    \\r\\n    -- Diferen\\u00e7a M\\u00e9dia vs IA\\r\\n    ROUND(AVG(ABS(diferenca_vs_ia_periodo)) * 100, 2) AS diferenca_media_vs_ia_pct,\\r\\n    \\r\\n    -- Per\\u00edodos\\r\\n    MIN(periodo) AS primeiro_periodo,\\r\\n    MAX(periodo) AS ultimo_periodo\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE cnpj_emitente = '00000000000191'  -- << MODIFIQUE AQUI\\r\\nGROUP BY cnpj_emitente, nm_razao_social;\\r\\n\\r\\n-- 3.2 DETALHE DOS PRODUTOS DA EMPRESA\\r\\nSELECT \\r\\n    'DETALHE DOS PRODUTOS DA EMPRESA' AS categoria,\\r\\n    \\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    ROUND(aliquota_ia * 100, 2) AS aliquota_correta_ia_pct,\\r\\n    \\r\\n    COUNT(DISTINCT periodo) AS periodos_observados,\\r\\n    \\r\\n    -- Al\\u00edquotas Praticadas\\r\\n    ROUND(AVG(aliq_emitente_periodo) * 100, 2) AS aliquota_praticada_media_pct,\\r\\n    ROUND(STDDEV(aliq_emitente_periodo) * 100, 2) AS desvio_praticada_pct,\\r\\n    ROUND(MIN(aliq_emitente_periodo) * 100, 2) AS aliquota_minima_pct,\\r\\n    ROUND(MAX(aliq_emitente_periodo) * 100, 2) AS aliquota_maxima_pct,\\r\\n    \\r\\n    -- Diferen\\u00e7a vs IA\\r\\n    ROUND(AVG(diferenca_vs_ia_periodo) * 100, 2) AS diferenca_media_vs_ia_pct,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Predominante\\r\\n    MAX(classificacao_mudanca) AS classificacao_predominante,\\r\\n    MAX(movimento_vs_ia) AS movimento_predominante,\\r\\n    \\r\\n    -- Volume Financeiro\\r\\n    SUM(bc_total_periodo) AS base_calculo_produto\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE cnpj_emitente = '00000000000191'  -- << MODIFIQUE AQUI\\r\\nGROUP BY gtin, ncm, descricao, aliquota_ia\\r\\nORDER BY base_calculo_produto DESC;\\r\\n\\r\\n-- 3.3 EVOLU\\u00c7\\u00c3O TEMPORAL DA EMPRESA\\r\\nSELECT \\r\\n    'EVOLU\\u00c7\\u00c3O TEMPORAL DA EMPRESA' AS categoria,\\r\\n    \\r\\n    periodo,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS produtos_periodo,\\r\\n    SUM(bc_total_periodo) AS base_calculo_periodo,\\r\\n    \\r\\n    -- Mudan\\u00e7as por Per\\u00edodo\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) AS mudancas_significativas,\\r\\n    \\r\\n    -- Movimento vs IA por Per\\u00edodo\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS aproximou_ia,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS afastou_ia,\\r\\n    \\r\\n    -- Taxa de Corre\\u00e7\\u00e3o por Per\\u00edodo\\r\\n    ROUND(SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_correcao_periodo_pct,\\r\\n    \\r\\n    -- Al\\u00edquota M\\u00e9dia do Per\\u00edodo\\r\\n    ROUND(AVG(aliq_emitente_periodo) * 100, 2) AS aliquota_media_periodo_pct,\\r\\n    ROUND(AVG(ABS(diferenca_vs_ia_periodo)) * 100, 2) AS diferenca_media_vs_ia_pct\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE cnpj_emitente = '00000000000191'  -- << MODIFIQUE AQUI\\r\\n  AND aliquota_ia IS NOT NULL\\r\\nGROUP BY periodo\\r\\nORDER BY periodo;\\r\\n\\r\\n-- ============================================================================\\r\\n-- 4. CONSULTAS ADICIONAIS RELEVANTES\\r\\n-- ============================================================================\\r\\n\\r\\n-- 4.1 PRODUTOS COM MAIOR IMPACTO ARRECADAT\\u00d3RIO POTENCIAL\\r\\nSELECT \\r\\n    'PRODUTOS - MAIOR IMPACTO ARRECADAT\\u00d3RIO' AS categoria,\\r\\n    \\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    ROUND(aliquota_ia * 100, 2) AS aliquota_correta_ia_pct,\\r\\n    \\r\\n    COUNT(DISTINCT cnpj_emitente) AS qtd_empresas,\\r\\n    SUM(bc_total_periodo) AS base_calculo_total,\\r\\n    \\r\\n    -- Diferen\\u00e7a M\\u00e9dia Praticada vs IA\\r\\n    ROUND(AVG(aliq_emitente_periodo - aliquota_ia) * 100, 2) AS diferenca_media_pct,\\r\\n    \\r\\n    -- Impacto Arrecadat\\u00f3rio Estimado (se todos corrigissem)\\r\\n    ROUND(SUM(bc_total_periodo * ABS(aliq_emitente_periodo - aliquota_ia)), 2) AS impacto_estimado,\\r\\n    \\r\\n    -- Empresas que j\\u00e1 corrigiram\\r\\n    COUNT(DISTINCT CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN cnpj_emitente END) AS empresas_corrigindo,\\r\\n    \\r\\n    ROUND(COUNT(DISTINCT CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN cnpj_emitente END) * 100.0 / \\r\\n          NULLIF(COUNT(DISTINCT cnpj_emitente), 0), 2) AS perc_empresas_corrigindo\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE aliquota_ia IS NOT NULL\\r\\n  AND ABS(aliq_emitente_periodo - aliquota_ia) > 0.01  -- Diferen\\u00e7a maior que 1%\\r\\nGROUP BY gtin, ncm, descricao, aliquota_ia\\r\\nHAVING COUNT(DISTINCT cnpj_emitente) >= 3\\r\\nORDER BY impacto_estimado DESC\\r\\nLIMIT 50;\\r\\n\\r\\n-- 4.2 ALERTAS AUTOM\\u00c1TICOS - EMPRESAS PRIORIT\\u00c1RIAS\\r\\nSELECT \\r\\n    'ALERTAS - EMPRESAS PRIORIT\\u00c1RIAS PARA FISCALIZA\\u00c7\\u00c3O' AS categoria,\\r\\n    \\r\\n    cnpj_emitente,\\r\\n    nm_razao_social,\\r\\n    \\r\\n    -- Tipo de Alerta\\r\\n    CASE \\r\\n        WHEN SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) >= \\r\\n             (COUNT(*) * 0.6) THEN 'CR\\u00cdTICO: Afastamento Sistem\\u00e1tico da Al\\u00edquota Correta'\\r\\n        \\r\\n        WHEN SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) >= 10 \\r\\n        THEN 'ALTO: M\\u00faltiplas Mudan\\u00e7as Extremas'\\r\\n        \\r\\n        WHEN AVG(ABS(diferenca_vs_ia_periodo)) > 0.05 AND SUM(bc_total_periodo) > 1000000\\r\\n        THEN 'ALTO: Grande Diferen\\u00e7a vs IA com Volume Significativo'\\r\\n        \\r\\n        WHEN SUM(CASE WHEN classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA') THEN 1 ELSE 0 END) >= \\r\\n             (COUNT(*) * 0.5)\\r\\n        THEN 'M\\u00c9DIO: Alta Volatilidade Tribut\\u00e1ria'\\r\\n        \\r\\n        ELSE 'BAIXO: Monitoramento Rotineiro'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- Prioridade (1=Mais alta, 4=Mais baixa)\\r\\n    CASE \\r\\n        WHEN SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) >= (COUNT(*) * 0.6) THEN 1\\r\\n        WHEN SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) >= 10 THEN 2\\r\\n        WHEN AVG(ABS(diferenca_vs_ia_periodo)) > 0.05 AND SUM(bc_total_periodo) > 1000000 THEN 2\\r\\n        WHEN SUM(CASE WHEN classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA') THEN 1 ELSE 0 END) >= (COUNT(*) * 0.5) THEN 3\\r\\n        ELSE 4\\r\\n    END AS prioridade,\\r\\n    \\r\\n    -- M\\u00e9tricas\\r\\n    COUNT(*) AS total_casos,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS casos_afastou_ia,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS mudancas_extremas,\\r\\n    SUM(bc_total_periodo) AS base_calculo_total,\\r\\n    ROUND(AVG(ABS(diferenca_vs_ia_periodo)) * 100, 2) AS diferenca_media_vs_ia_pct\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE aliquota_ia IS NOT NULL\\r\\nGROUP BY cnpj_emitente, nm_razao_social\\r\\nHAVING \\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) >= (COUNT(*) * 0.3) OR\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) >= 5 OR\\r\\n    (AVG(ABS(diferenca_vs_ia_periodo)) > 0.03 AND SUM(bc_total_periodo) > 500000)\\r\\nORDER BY prioridade, base_calculo_total DESC;\\r\\n\\r\\n-- 4.3 DASHBOARD EXECUTIVO - KPIs PRINCIPAIS\\r\\nSELECT \\r\\n    'DASHBOARD EXECUTIVO - KPIs' AS categoria,\\r\\n    \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT cnpj_emitente) AS total_empresas,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS total_produtos,\\r\\n    SUM(bc_total_periodo) AS base_calculo_total_sistema,\\r\\n    \\r\\n    -- Taxa de Corre\\u00e7\\u00e3o Global\\r\\n    ROUND(SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_correcao_global_pct,\\r\\n    \\r\\n    -- Empresas com Comportamento Corretivo\\r\\n    COUNT(DISTINCT CASE \\r\\n        WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' \\r\\n        THEN cnpj_emitente \\r\\n    END) AS empresas_corrigindo,\\r\\n    \\r\\n    ROUND(COUNT(DISTINCT CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN cnpj_emitente END) * 100.0 / \\r\\n          NULLIF(COUNT(DISTINCT cnpj_emitente), 0), 2) AS perc_empresas_corrigindo,\\r\\n    \\r\\n    -- Mudan\\u00e7as Relevantes\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS total_mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) AS total_mudancas_significativas,\\r\\n    \\r\\n    -- Impacto Arrecadat\\u00f3rio Estimado\\r\\n    ROUND(SUM(CASE \\r\\n        WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' \\r\\n        THEN bc_total_periodo * ABS(diferenca_vs_ia_historica) \\r\\n        ELSE 0 \\r\\n    END), 2) AS impacto_arrecadatorio_correcoes,\\r\\n    \\r\\n    -- Per\\u00edodo de An\\u00e1lise\\r\\n    MIN(periodo) AS periodo_inicial,\\r\\n    MAX(periodo) AS periodo_final,\\r\\n    \\r\\n    -- Timestamp\\r\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_atualizacao\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE aliquota_ia IS NOT NULL;\", \"statementsList\": [\"-- ============================================================================\\r\\n-- SISTEMA ARGOS - CONSULTAS ANAL\\u00cdTICAS COMPLETAS\\r\\n-- An\\u00e1lise de Mudan\\u00e7a de Comportamento Tribut\\u00e1rio\\r\\n-- Receita Estadual de Santa Catarina\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\", \"\\r\\nSET MEM_LIMIT = 8G;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- 1. ESTAT\\u00cdSTICAS GERAIS DO SISTEMA ARGOS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 1.1 PANORAMA GERAL DO SISTEMA\\r\\nSELECT \\r\\n    'PANORAMA GERAL DO SISTEMA ARGOS' AS categoria,\\r\\n    \\r\\n    -- M\\u00e9tricas de Volume\\r\\n    COUNT(DISTINCT cnpj_emitente) AS total_empresas_monitoradas,\\r\\n    COUNT(DISTINCT periodo) AS total_periodos_analisados,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS total_produtos_distintos,\\r\\n    COUNT(*) AS total_registros_base,\\r\\n    \\r\\n    -- M\\u00e9tricas de Cobertura de Dados\\r\\n    COUNT(DISTINCT CASE WHEN aliquota_ia IS NOT NULL THEN CONCAT(gtin, '-', ncm) END) AS produtos_com_aliquota_ia,\\r\\n    ROUND(COUNT(DISTINCT CASE WHEN aliquota_ia IS NOT NULL THEN CONCAT(gtin, '-', ncm) END) * 100.0 / \\r\\n          COUNT(DISTINCT CONCAT(gtin, '-', ncm)), 2) AS perc_cobertura_ia,\\r\\n    \\r\\n    -- M\\u00e9tricas Financeiras\\r\\n    SUM(bc_total_periodo) AS base_calculo_total_sistema,\\r\\n    ROUND(AVG(bc_total_periodo), 2) AS bc_media_por_registro,\\r\\n    \\r\\n    -- M\\u00e9tricas de Qualidade\\r\\n    COUNT(CASE WHEN gtin = 'SEM GTIN' THEN 1 END) AS registros_sem_gtin,\\r\\n    ROUND(COUNT(CASE WHEN gtin = 'SEM GTIN' THEN 1 END) * 100.0 / COUNT(*), 2) AS perc_sem_gtin,\\r\\n    \\r\\n    -- Data de Atualiza\\u00e7\\u00e3o\\r\\n    MAX(periodo) AS ultimo_periodo_processado,\\r\\n    MIN(periodo) AS primeiro_periodo_processado,\\r\\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_consulta\\r\\n    \\r\\nFROM niat.argos_nfce_periodo_base;\", \"\\r\\n\\r\\n-- 1.2 DISTRIBUI\\u00c7\\u00c3O DE MUDAN\\u00c7AS POR CLASSIFICA\\u00c7\\u00c3O\\r\\nSELECT \\r\\n    'DISTRIBUI\\u00c7\\u00c3O DE MUDAN\\u00c7AS POR CLASSIFICA\\u00c7\\u00c3O' AS categoria,\\r\\n    \\r\\n    classificacao_mudanca,\\r\\n    COUNT(*) AS quantidade_casos,\\r\\n    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS percentual,\\r\\n    COUNT(DISTINCT cnpj_emitente) AS empresas_afetadas,\\r\\n    SUM(bc_total_periodo) AS base_calculo_total,\\r\\n    ROUND(AVG(bc_total_periodo), 2) AS bc_media,\\r\\n    \\r\\n    -- M\\u00e9tricas de Movimento vs IA\\r\\n    COUNT(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 END) AS casos_aproximou_ia,\\r\\n    COUNT(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 END) AS casos_afastou_ia,\\r\\n    COUNT(CASE WHEN movimento_vs_ia = 'MANTEVE_DISTANCIA' THEN 1 END) AS casos_manteve_distancia,\\r\\n    \\r\\n    -- Percentuais de Movimento\\r\\n    ROUND(COUNT(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS perc_aproximou\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE classificacao_mudanca IS NOT NULL\\r\\nGROUP BY classificacao_mudanca\\r\\nORDER BY quantidade_casos DESC;\", \"\\r\\n\\r\\n-- 1.3 EVOLU\\u00c7\\u00c3O TEMPORAL DAS MUDAN\\u00c7AS\\r\\nSELECT \\r\\n    'EVOLU\\u00c7\\u00c3O TEMPORAL DAS MUDAN\\u00c7AS' AS categoria,\\r\\n    \\r\\n    periodo,\\r\\n    COUNT(*) AS total_casos_periodo,\\r\\n    COUNT(DISTINCT cnpj_emitente) AS empresas_ativas_periodo,\\r\\n    SUM(bc_total_periodo) AS base_calculo_periodo,\\r\\n    \\r\\n    -- Distribui\\u00e7\\u00e3o por Classifica\\u00e7\\u00e3o\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) AS mudancas_significativas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'COMPORTAMENTO_NORMAL' THEN 1 ELSE 0 END) AS comportamento_normal,\\r\\n    \\r\\n    -- Movimento vs Al\\u00edquota Correta\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS aproximou_da_correta,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS afastou_da_correta,\\r\\n    \\r\\n    -- Taxa de Corre\\u00e7\\u00e3o do Per\\u00edodo\\r\\n    ROUND(SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_correcao_periodo\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nGROUP BY periodo\\r\\nORDER BY periodo DESC;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- 2. CONSULTAS ANAL\\u00cdTICAS ESPEC\\u00cdFICAS\\r\\n-- ============================================================================\\r\\n\\r\\n-- 2.1 RANKING DE EMPRESAS POR MUDAN\\u00c7AS EXTREMAS\\r\\nSELECT \\r\\n    'TOP 20 EMPRESAS - MUDAN\\u00c7AS EXTREMAS' AS categoria,\\r\\n    \\r\\n    mc.cnpj_emitente,\\r\\n    mc.nm_razao_social,\\r\\n    COUNT(*) AS total_mudancas_extremas,\\r\\n    COUNT(DISTINCT periodo) AS periodos_com_mudancas,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS produtos_afetados,\\r\\n    SUM(bc_total_periodo) AS base_calculo_total,\\r\\n    \\r\\n    -- Dire\\u00e7\\u00e3o das Mudan\\u00e7as\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS casos_aproximou,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS casos_afastou,\\r\\n    \\r\\n    -- Taxa de Corre\\u00e7\\u00e3o\\r\\n    ROUND(SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) * 100.0 / \\r\\n          COUNT(*), 2) AS taxa_correcao_empresa,\\r\\n    \\r\\n    -- Per\\u00edodo mais recente\\r\\n    MAX(periodo) AS ultimo_periodo_ativo\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento mc\\r\\nWHERE classificacao_mudanca = 'MUDANCA_EXTREMA'\\r\\nGROUP BY mc.cnpj_emitente, mc.nm_razao_social\\r\\nORDER BY total_mudancas_extremas DESC, base_calculo_total DESC\\r\\nLIMIT 20;\", \"\\r\\n\\r\\n-- 2.2 AN\\u00c1LISE DE PRODUTOS COM MAIOR VOLATILIDADE\\r\\nSELECT \\r\\n    'TOP 30 PRODUTOS - MAIOR VOLATILIDADE' AS categoria,\\r\\n    \\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    aliquota_ia,\\r\\n    \\r\\n    COUNT(DISTINCT cnpj_emitente) AS qtd_empresas_praticantes,\\r\\n    COUNT(DISTINCT periodo) AS qtd_periodos_observados,\\r\\n    \\r\\n    -- Estat\\u00edsticas de Al\\u00edquota\\r\\n    ROUND(AVG(aliq_emitente_periodo) * 100, 2) AS aliquota_media_pct,\\r\\n    ROUND(STDDEV(aliq_emitente_periodo) * 100, 2) AS desvio_padrao_pct,\\r\\n    ROUND(MIN(aliq_emitente_periodo) * 100, 2) AS aliquota_minima_pct,\\r\\n    ROUND(MAX(aliq_emitente_periodo) * 100, 2) AS aliquota_maxima_pct,\\r\\n    \\r\\n    -- Diferen\\u00e7a vs IA\\r\\n    ROUND(AVG(diferenca_vs_ia_periodo) * 100, 2) AS diferenca_media_vs_ia_pct,\\r\\n    \\r\\n    -- Volume Financeiro\\r\\n    SUM(bc_total_periodo) AS base_calculo_acumulada,\\r\\n    \\r\\n    -- Casos de Mudan\\u00e7a\\r\\n    SUM(CASE WHEN classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA') THEN 1 ELSE 0 END) AS casos_mudanca_relevante\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE aliquota_ia IS NOT NULL\\r\\nGROUP BY gtin, ncm, descricao, aliquota_ia\\r\\nHAVING COUNT(DISTINCT cnpj_emitente) >= 3  -- Produtos praticados por pelo menos 3 empresas\\r\\nORDER BY STDDEV(aliq_emitente_periodo) DESC, base_calculo_acumulada DESC\\r\\nLIMIT 30;\", \"\\r\\n\\r\\n-- 2.3 EFETIVIDADE DA FISCALIZA\\u00c7\\u00c3O (Empresas que Corrigiram)\\r\\nWITH empresas_fiscalizadas AS (\\r\\n    SELECT DISTINCT cnpj \\r\\n    FROM niat.argos_cnpj\\r\\n),\\r\\nanalise_correcao AS (\\r\\n    SELECT \\r\\n        mc.cnpj_emitente,\\r\\n        mc.nm_razao_social,\\r\\n        COUNT(*) AS total_produtos_analisados,\\r\\n        SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS produtos_corrigidos,\\r\\n        SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS produtos_piorados,\\r\\n        SUM(CASE WHEN classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA') THEN 1 ELSE 0 END) AS mudancas_relevantes,\\r\\n        SUM(bc_total_periodo) AS base_calculo_total,\\r\\n        AVG(ABS(diferenca_vs_ia_periodo)) AS diferenca_media_vs_ia\\r\\n    FROM niat.argos_mudanca_comportamento mc\\r\\n    INNER JOIN empresas_fiscalizadas ef ON mc.cnpj_emitente = ef.cnpj\\r\\n    WHERE aliquota_ia IS NOT NULL\\r\\n    GROUP BY mc.cnpj_emitente, mc.nm_razao_social\\r\\n)\\r\\nSELECT \\r\\n    'EFETIVIDADE DA FISCALIZA\\u00c7\\u00c3O' AS categoria,\\r\\n    \\r\\n    cnpj_emitente,\\r\\n    nm_razao_social,\\r\\n    total_produtos_analisados,\\r\\n    produtos_corrigidos,\\r\\n    produtos_piorados,\\r\\n    mudancas_relevantes,\\r\\n    \\r\\n    -- Taxa de Corre\\u00e7\\u00e3o\\r\\n    ROUND(produtos_corrigidos * 100.0 / NULLIF(total_produtos_analisados, 0), 2) AS taxa_correcao_pct,\\r\\n    \\r\\n    -- Padr\\u00e3o Comportamental\\r\\n    CASE \\r\\n        WHEN produtos_corrigidos >= (total_produtos_analisados * 0.6) THEN 'CORRIGINDO_ALIQUOTAS'\\r\\n        WHEN produtos_piorados >= (total_produtos_analisados * 0.6) THEN 'PIORANDO_ALIQUOTAS'\\r\\n        WHEN mudancas_relevantes >= (total_produtos_analisados * 0.4) THEN 'ALTA_VARIABILIDADE'\\r\\n        ELSE 'COMPORTAMENTO_ESTAVEL'\\r\\n    END AS padrao_comportamental,\\r\\n    \\r\\n    base_calculo_total,\\r\\n    ROUND(diferenca_media_vs_ia * 100, 2) AS diferenca_media_vs_ia_pct\\r\\n    \\r\\nFROM analise_correcao\\r\\nORDER BY taxa_correcao_pct DESC, base_calculo_total DESC;\", \"\\r\\n\\r\\n-- 2.4 AN\\u00c1LISE SETORIAL POR NCM (2 D\\u00cdGITOS)\\r\\nWITH ncm_secao AS (\\r\\n    SELECT \\r\\n        SUBSTR(CAST(ncm AS STRING), 1, 2) AS secao_ncm,\\r\\n        cnpj_emitente,\\r\\n        periodo,\\r\\n        gtin,\\r\\n        ncm,\\r\\n        descricao,\\r\\n        aliquota_ia,\\r\\n        aliq_emitente_periodo,\\r\\n        bc_total_periodo,\\r\\n        classificacao_mudanca,\\r\\n        movimento_vs_ia\\r\\n    FROM niat.argos_mudanca_comportamento\\r\\n    WHERE ncm IS NOT NULL\\r\\n)\\r\\nSELECT \\r\\n    'AN\\u00c1LISE SETORIAL POR NCM' AS categoria,\\r\\n    \\r\\n    secao_ncm,\\r\\n    CASE secao_ncm\\r\\n        WHEN '01' THEN 'Animais Vivos'\\r\\n        WHEN '02' THEN 'Carnes'\\r\\n        WHEN '04' THEN 'Leite e Latic\\u00ednios'\\r\\n        WHEN '17' THEN 'A\\u00e7\\u00facares'\\r\\n        WHEN '19' THEN 'Produtos de Cereais'\\r\\n        WHEN '22' THEN 'Bebidas'\\r\\n        WHEN '33' THEN '\\u00d3leos Essenciais e Cosm\\u00e9ticos'\\r\\n        WHEN '84' THEN 'M\\u00e1quinas e Equipamentos'\\r\\n        ELSE CONCAT('Se\\u00e7\\u00e3o ', secao_ncm)\\r\\n    END AS descricao_secao,\\r\\n    \\r\\n    COUNT(DISTINCT cnpj_emitente) AS empresas_no_setor,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS produtos_distintos,\\r\\n    COUNT(*) AS total_registros,\\r\\n    \\r\\n    -- Estat\\u00edsticas de Al\\u00edquota\\r\\n    ROUND(AVG(aliq_emitente_periodo) * 100, 2) AS aliquota_media_setor_pct,\\r\\n    ROUND(STDDEV(aliq_emitente_periodo) * 100, 2) AS desvio_aliquota_pct,\\r\\n    \\r\\n    -- Taxa de Corre\\u00e7\\u00e3o Setorial\\r\\n    ROUND(SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_correcao_setor_pct,\\r\\n    \\r\\n    -- Mudan\\u00e7as Significativas\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) AS mudancas_significativas,\\r\\n    \\r\\n    -- Volume Financeiro\\r\\n    SUM(bc_total_periodo) AS base_calculo_setor\\r\\n    \\r\\nFROM ncm_secao\\r\\nWHERE aliquota_ia IS NOT NULL\\r\\nGROUP BY secao_ncm\\r\\nHAVING COUNT(DISTINCT cnpj_emitente) >= 3  -- Setores com pelo menos 3 empresas\\r\\nORDER BY base_calculo_setor DESC;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- 3. AN\\u00c1LISES COMPLETAS (DOSSI\\u00ca DE EMPRESAS ESPEC\\u00cdFICAS)\\r\\n-- ============================================================================\\r\\n\\r\\n-- 3.1 DOSSI\\u00ca COMPLETO DE UMA EMPRESA\\r\\n-- Substitua '00000000000191' pelo CNPJ desejado\\r\\nSELECT \\r\\n    'DOSSI\\u00ca COMPLETO DA EMPRESA' AS categoria,\\r\\n    \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    cnpj_emitente,\\r\\n    nm_razao_social,\\r\\n    \\r\\n    -- Estat\\u00edsticas Gerais\\r\\n    COUNT(DISTINCT periodo) AS periodos_analisados,\\r\\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS produtos_distintos,\\r\\n    COUNT(*) AS total_registros,\\r\\n    \\r\\n    -- M\\u00e9tricas de Mudan\\u00e7a\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS mudancas_extremas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_SIGNIFICATIVA' THEN 1 ELSE 0 END) AS mudancas_significativas,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'COMPORTAMENTO_NORMAL' THEN 1 ELSE 0 END) AS comportamento_normal,\\r\\n    \\r\\n    -- Movimento vs IA\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) AS casos_aproximou_ia,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS casos_afastou_ia,\\r\\n    \\r\\n    -- Taxa de Corre\\u00e7\\u00e3o\\r\\n    ROUND(SUM(CASE WHEN movimento_vs_ia = 'APROXIMOU_DA_CORRETA' THEN 1 ELSE 0 END) * 100.0 / \\r\\n          NULLIF(COUNT(*), 0), 2) AS taxa_correcao_empresa_pct,\\r\\n    \\r\\n    -- Volume Financeiro\\r\\n    SUM(bc_total_periodo) AS base_calculo_total,\\r\\n    ROUND(AVG(bc_total_periodo), 2) AS bc_media_por_registro,\\r\\n    \\r\\n    -- Diferen\\u00e7a M\\u00e9dia vs IA\\r\\n    ROUND(AVG(ABS(diferenca_vs_ia_periodo)) * 100, 2) AS diferenca_media_vs_ia_pct,\\r\\n    \\r\\n    -- Per\\u00edodos\\r\\n    MIN(periodo) AS primeiro_periodo,\\r\\n    MAX(periodo) AS ultimo_periodo\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE cnpj_emitente = '00000000000191'  -- << MODIFIQUE AQUI\\r\\nGROUP BY cnpj_emitente, nm_razao_social;\", \"\\r\\n\\r\\n-- 3.2 DETALHE DOS PRODUTOS DA EMPRESA\\r\\nSELECT \\r\\n    'DETALHE DOS PRODUTOS DA EMPRESA' AS categoria,\\r\\n    \\r\\n    gtin,\\r\\n    ncm,\\r\\n    descricao,\\r\\n    ROUND(aliquota_ia * 100, 2) AS aliquota_correta_ia_pct,\\r\\n    \\r\\n    COUNT(DISTINCT periodo) AS periodos_observados,\\r\\n    \\r\\n    -- Al\\u00edquotas Praticadas\\r\\n    ROUND(AVG(aliq_emitente_periodo) * 100, 2) AS aliquota_praticada_media_pct,\\r\\n    ROUND(STDDEV(aliq_emitente_periodo) * 100, 2) AS desvio_praticada_pct,\\r\\n    ROUND(MIN(aliq_emitente_periodo) * 100, 2) AS aliquota_minima_pct,\\r\\n    ROUND(MAX(aliq_emitente_periodo) * 100, 2) AS aliquota_maxima_pct,\\r\\n    \\r\\n    -- Diferen\\u00e7a vs IA\\r\\n    ROUND(AVG(diferenca_vs_ia_periodo) * 100, 2) AS diferenca_media_vs_ia_pct,\\r\\n    \\r\\n    -- Classifica\\u00e7\\u00e3o Predominante\\r\\n    MAX(classificacao_mudanca) AS classificacao_predominante,\\r\\n    MAX(movimento_vs_ia) AS movimento_predominante,\\r\\n    \\r\\n    -- Volume Financeiro\\r\\n    SUM(bc_total_periodo) AS base_calculo_produto\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE cnpj_emitente = '00000000000191'  -- << MODIFIQUE AQUI\\r\\nGROUP BY gtin, ncm, descricao, aliquota_ia\\r\\nORDER BY base_calculo_produto DESC;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ============================================================================\\r\\n-- SISTEMA ARGOS - CONSULTAS ANAL\\u00cdTICAS COMPLETAS\\r\\n-- An\\u00e1lise de Mudan\\u00e7a de Comportamento Tribut\\u00e1rio\\r\\n-- Receita Estadual de Santa Catarina\\r\\n-- ============================================================================\\r\\n\\r\\nSET REQUEST_POOL = 'medium';\", \"result\": {\"id\": \"3c28cc98-b74e-9294-8e77-c60224b415cc\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"6DFJqfebTI+6Kk6qHPTb0g==\", \"guid\": \"dhF/tSaHR2AAAAAAG2c1Rw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"e048a602c75d2ef3:b097a608997311a7\", \"session_id\": 21048, \"session_type\": \"impala\", \"statement_id\": 0, \"has_more_statements\": false, \"statements_count\": 1, \"previous_statement_hash\": \"e75ca47a2398c419db0499e27c78f52984efb0dad875830d0454ed6c\", \"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 2416}, \"statement\": \"-- 4.2 ALERTAS AUTOM\\u00c1TICOS - EMPRESAS PRIORIT\\u00c1RIAS\\r\\nSELECT \\r\\n    'ALERTAS - EMPRESAS PRIORIT\\u00c1RIAS PARA FISCALIZA\\u00c7\\u00c3O' AS categoria,\\r\\n    \\r\\n    cnpj_emitente,\\r\\n    nm_razao_social,\\r\\n    \\r\\n    -- Tipo de Alerta\\r\\n    CASE \\r\\n        WHEN SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) >= \\r\\n             (COUNT(*) * 0.6) THEN 'CR\\u00cdTICO: Afastamento Sistem\\u00e1tico da Al\\u00edquota Correta'\\r\\n        \\r\\n        WHEN SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) >= 10 \\r\\n        THEN 'ALTO: M\\u00faltiplas Mudan\\u00e7as Extremas'\\r\\n        \\r\\n        WHEN AVG(ABS(diferenca_vs_ia_periodo)) > 0.05 AND SUM(bc_total_periodo) > 1000000\\r\\n        THEN 'ALTO: Grande Diferen\\u00e7a vs IA com Volume Significativo'\\r\\n        \\r\\n        WHEN SUM(CASE WHEN classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA') THEN 1 ELSE 0 END) >= \\r\\n             (COUNT(*) * 0.5)\\r\\n        THEN 'M\\u00c9DIO: Alta Volatilidade Tribut\\u00e1ria'\\r\\n        \\r\\n        ELSE 'BAIXO: Monitoramento Rotineiro'\\r\\n    END AS tipo_alerta,\\r\\n    \\r\\n    -- Prioridade (1=Mais alta, 4=Mais baixa)\\r\\n    CASE \\r\\n        WHEN SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) >= (COUNT(*) * 0.6) THEN 1\\r\\n        WHEN SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) >= 10 THEN 2\\r\\n        WHEN AVG(ABS(diferenca_vs_ia_periodo)) > 0.05 AND SUM(bc_total_periodo) > 1000000 THEN 2\\r\\n        WHEN SUM(CASE WHEN classificacao_mudanca IN ('MUDANCA_EXTREMA', 'MUDANCA_SIGNIFICATIVA') THEN 1 ELSE 0 END) >= (COUNT(*) * 0.5) THEN 3\\r\\n        ELSE 4\\r\\n    END AS prioridade,\\r\\n    \\r\\n    -- M\\u00e9tricas\\r\\n    COUNT(*) AS total_casos,\\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) AS casos_afastou_ia,\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) AS mudancas_extremas,\\r\\n    SUM(bc_total_periodo) AS base_calculo_total,\\r\\n    ROUND(AVG(ABS(diferenca_vs_ia_periodo)) * 100, 2) AS diferenca_media_vs_ia_pct\\r\\n    \\r\\nFROM niat.argos_mudanca_comportamento\\r\\nWHERE aliquota_ia IS NOT NULL\\r\\nGROUP BY cnpj_emitente, nm_razao_social\\r\\nHAVING \\r\\n    SUM(CASE WHEN movimento_vs_ia = 'AFASTOU_DA_CORRETA' THEN 1 ELSE 0 END) >= (COUNT(*) * 0.3) OR\\r\\n    SUM(CASE WHEN classificacao_mudanca = 'MUDANCA_EXTREMA' THEN 1 ELSE 0 END) >= 5 OR\\r\\n    (AVG(ABS(diferenca_vs_ia_periodo)) > 0.03 AND SUM(bc_total_periodo) > 500000)\\r\\nORDER BY prioridade, base_calculo_total DESC\"}, \"meta\": [], \"rows\": 28, \"hasMore\": false, \"statement_id\": 0, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-10-01T14:21:19.657Z\", \"endTime\": \"2025-10-01T14:21:21.032Z\", \"executionTime\": 1375, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"categoria\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"total_casos\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"categoria\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"total_casos\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1759328479371, \"lastAceSelectionRowOffset\": 500, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 77.5, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 100, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- SISTEMA ARGOS - CONSULTAS ANALÍTICAS COMPLETAS\r\n-- Análise de Mudança de Comportamento Tributário\r\n-- Receita Estadual de Santa Catarina\r\n-- ============================================================================\r\n\r\nSET REQUEST_POOL = 'medium';\r\nSET MEM_LIMIT = 8G;\r\n\r\n-- ============================================================================\r\n-- 1. ESTATÍSTICAS GERAIS DO SISTEMA ARGOS\r\n-- ============================================================================\r\n\r\n-- 1.1 PANORAMA GERAL DO SISTEMA\r\nSELECT \r\n    'PANORAMA GERAL DO SISTEMA ARGOS' AS categoria,\r\n    \r\n    -- Métricas de Volume\r\n    COUNT(DISTINCT cnpj_emitente) AS total_empresas_monitoradas,\r\n    COUNT(DISTINCT periodo) AS total_periodos_analisados,\r\n    COUNT(DISTINCT CONCAT(gtin, '-', ncm)) AS total_produtos_distintos,\r\n    COUNT(*) AS total_registros_base,\r\n    \r\n    -- Métricas de Cobertura de Dados\r\n    COUNT(DISTINCT CASE WHEN aliquota_ia IS NOT NULL THEN CONCAT(gtin, '-', ncm) END) AS produtos_com_aliquota_ia,\r\n    ROUND(COUNT(DISTINCT CASE WHEN aliquota_ia IS NOT NULL THEN CONCAT(gtin, '-', ncm) END) * 100.0 / \r\n          COUNT(DISTINCT CONCAT(gtin, '-', ncm)), 2) AS perc_cobertura_ia,\r\n    \r\n    -- Métricas Financeiras\r\n    SUM(bc_total_periodo) AS base_calculo_total_sistema,\r\n    ROUND(AVG(bc_total_periodo), 2) AS bc_media_por_registro,\r\n    \r\n    -- Métricas de Qualidade\r\n    COUNT(CASE WHEN gtin = 'SEM GTIN' THEN 1 END) AS registros_sem_gtin,\r\n    ROUND(COUNT(CASE WHEN gtin = 'SEM GTIN' THEN 1 END) * 100.0 / COUNT(*), 2) AS perc_sem_gtin,\r\n    \r\n    -- Data de Atualização\r\n    MAX(periodo) AS ultimo_periodo_processado,\r\n    MIN(periodo) AS primeiro_periodo_processado,\r\n    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS data_consulta\r\n    \r\nFROM niat.argos_nfce_periodo_base;\r\n\r\n-- 1.2 DISTRIBUIÇÃO DE MUDANÇAS POR CLASSIFICAÇÃO\r\nSELECT \r\n    'DISTRIBUIÇÃO DE MUDANÇAS POR CLASSIFICAÇÃO' AS categoria,\r\n    \r\n   ",
    "last_modified": "2025-10-02T17:43:03.876",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "9c31952e-c6b2-404c-9369-a01b5cd73495",
      1,
      false
    ],
    "dependencies": []
  }
}
]
